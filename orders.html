<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>الطلبات - نظام المراد</title>
  <style>
    body {
      font-family: Tahoma, Arial;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }
    header {
      background: #043B64;
      color: white;
      text-align: center;
      padding: 12px;
      font-size: 18px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
    }
    .back-btn {
      background: #043B64;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 13px;
    }
    .delete-btn {
      background: #d93025;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 13px;
    }
    .search-bar {
      text-align: center;
      margin: 10px 0 15px;
    }
    .search-bar input {
      width: 60%;
      padding: 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .table-container {
      width: 100%;
      overflow-x: auto;
      white-space: nowrap;
      padding: 10px;
    }
    table {
      width: max-content;
      min-width: 1400px;
      margin: 0 auto;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 6px 8px;
      text-align: center;
      border-bottom: 1px solid #ddd;
      font-size: 12px;
    }
    th { background: #043B64; color: white; }
    tr:hover { background: #f9fafb; }
    input, select, textarea {
      font-size: 12px;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
    }
    textarea { resize: vertical; height: 40px; }
    button {
      background: #FF6B2D;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }
    /* 🔸 منع التقريب التلقائي بالموبايل */
input, select, textarea {
  font-size: 16px !important;
}

    button:hover { opacity: 0.9; }
    /* 🔽 قائمة منسدلة للأوامر */
.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #ffffff;
  min-width: 200px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  border-radius: 6px;
  z-index: 9999;
  right: 0;
  top: 40px;
}

.dropdown-content button {
  background: none;
  color: #333;
  border: none;
  padding: 10px 15px;
  text-align: right;
  width: 100%;
  font-size: 13px;
  cursor: pointer;
}

.dropdown-content button:hover {
  background-color: #f1f1f1;
}

/* 🔸 ظهور القائمة عند الضغط */
.show {
  display: block;
}

  </style>
</head>
<body>

  <header id="pageTitle">📦 الطلبات</header>

  <div class="top-bar">
  <button class="back-btn" id="backBtn">🔙 رجوع إلى لوحة التحكم</button>
  <div class="dropdown">
    <button class="back-btn" id="commandsBtn">⚙️ أوامر الوسيط ▾</button>
    <div class="dropdown-content" id="commandsMenu">
      <button id="sendToWaseet">🚀 رفع الطلبات المثبتة</button>
      <button id="updateStatuses">🔄 تحديث الحالات</button>
    </div>
  </div>
  <button class="delete-btn" id="deleteSelected">🗑 حذف المحددة</button>
</div>


  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="🔍 ابحث عن أي معلومة...">
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>اختيار</th>
          <th>#</th>
          <th>تفاصيل</th>
          <th>الكود</th>
          <th>رقم الهاتف</th>
          <th>الرقم الثاني</th>
          <th>المحافظة</th>
          <th>المنطقة</th>
          <th>وصف العنوان</th>
          <th>السعر</th>
          <th>عدد القطع</th>
          <th>اسم المنتج</th>
          <th>الملاحظات</th>
          <th>رقم الوصل</th>
          <th>الحالة</th>
          <th>تاريخ الطلب</th>
          <th>المعلن</th>
        </tr>
      </thead>
      <tbody id="ordersBody">
        <tr><td colspan="17">⏳ جاري تحميل الطلبات...</td></tr>
      </tbody>
    </table>
  </div>
<script type="module">
  import { waseetCities } from "./waseetCities.js";
  import { waseetRegions } from "./waseetRegions.js";
  import { citiesData, allCities } from "./citiesData.js";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getDatabase, ref, onValue, update, remove, get } 
    from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
      authDomain: "almurad-system.firebaseapp.com",
      databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
      projectId: "almurad-system",
      storageBucket: "almurad-system.appspot.com",
      messagingSenderId: "911755824405",
      appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
    };

   const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ordersBody = document.getElementById("ordersBody");
const searchInput = document.getElementById("searchInput");

// 🔹 نضيف هذا السطر هنا
const currentUser = sessionStorage.getItem("userName") || "غير معروف";


    let allProducts = [];
    let allOrders = [];
    const urlParams = new URLSearchParams(window.location.search);
    const currentStatus = decodeURIComponent(urlParams.get("status") || "");

    // تحميل المنتجات
    const productsRef = ref(db, "products");
    onValue(productsRef, (snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        allProducts = Object.values(data).map(p => p.name || p);
      }
    });

    // تحميل الطلبات مع فلترة دقيقة
    const ordersRef = ref(db, "orders");
    onValue(ordersRef, (snapshot) => {
      if (!snapshot.exists()) {
        ordersBody.innerHTML = `<tr><td colspan="17">🚫 لا توجد طلبات</td></tr>`;
        return;
      }

      allOrders = Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data }));
      
      // فلترة حسب الحالة الحالية
      const filtered = allOrders.filter(o => {
        const st = (o.status || "").trim();
        return currentStatus === "" 
          ? (st === "" || st === null)
          : st === currentStatus;
      });

      renderOrders(filtered);
    });

    // أدوات الإدخال والمنسدلات
    function createEditableInput(value, onSave) {
      const input = document.createElement("input");
      input.value = value || "";
      input.addEventListener("change", e => onSave(e.target.value));
      return input;
    }

    function createTextarea(value, onSave) {
      const t = document.createElement("textarea");
      t.value = value || "";
      t.addEventListener("change", e => onSave(e.target.value));
      return t;
    }

    function createDropdown(options, selected, onChange) {
      const wrapper = document.createElement("div");
      const input = document.createElement("input");
      input.type = "text";
      input.value = selected || "";
      input.placeholder = "اختر...";
      input.style.cursor = "pointer";

      const dropdown = document.createElement("div");
      Object.assign(dropdown.style, {
        position: "fixed",
        background: "#fff",
        border: "1px solid #ccc",
        borderRadius: "6px",
        boxShadow: "0 3px 10px rgba(0,0,0,0.2)",
        maxHeight: "200px",
        overflowY: "auto",
        zIndex: "999999",
        display: "none",
        fontSize: "12px"
      });

      function renderList(filter = "") {
        dropdown.innerHTML = "";
        options.filter(o => o.includes(filter)).forEach(o => {
          const opt = document.createElement("div");
          opt.textContent = o;
          opt.style.padding = "5px 8px";
          opt.style.cursor = "pointer";
          opt.addEventListener("click", () => {
            input.value = o;
            dropdown.style.display = "none";
            onChange(o);
          });
          dropdown.appendChild(opt);
        });
      }

      input.addEventListener("focus", () => {
        const rect = input.getBoundingClientRect();
        dropdown.style.top = rect.bottom + "px";
        dropdown.style.left = rect.left + "px";
        dropdown.style.width = rect.width + "px";
        dropdown.style.display = "block";
        renderList();
      });

      input.addEventListener("input", e => renderList(e.target.value.trim()));
      document.addEventListener("click", e => {
        if (!wrapper.contains(e.target)) dropdown.style.display = "none";
      });

      wrapper.appendChild(input);
      document.body.appendChild(dropdown);
      return wrapper;
    }

    // عرض الطلبات
    function renderOrders(orders) {
      ordersBody.innerHTML = "";
      if (orders.length === 0) {
        ordersBody.innerHTML = `<tr><td colspan="17">🚫 لا توجد طلبات في هذه الحالة</td></tr>`;
        return;
      }

      orders.forEach((order, index) => {
        const tr = document.createElement("tr");
        const areas = citiesData[order.city] || [];

        // ✅ اختيار
        const selectTd = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.dataset.id = order.id;
        selectTd.appendChild(checkbox);
        tr.appendChild(selectTd);

        // 🔢 تسلسل
        const indexTd = document.createElement("td");
        indexTd.textContent = index + 1;
        tr.appendChild(indexTd);

        // 🔍 تفاصيل
        const detailsTd = document.createElement("td");
        const detailsBtn = document.createElement("button");
        detailsBtn.textContent = "🔍 تفاصيل";
        detailsBtn.style.background = "#FF6B2D";
detailsBtn.addEventListener("click", () => {
  const modal = document.getElementById("detailsModal");
  const frame = document.getElementById("detailsFrame");
  localStorage.setItem("selectedOrder", order.id);
  frame.src = "order-details.html"; // نستخدم نفس الصفحة الأصلية
  modal.style.display = "block";

  // السماح بإغلاقها بزر رجوع
  window.addEventListener("message", (e) => {
    if (e.data === "closeDetailsModal") {
      modal.style.display = "none";
      frame.src = "";
    }
  });
});

        detailsTd.appendChild(detailsBtn);
        tr.appendChild(detailsTd);

        // بقية الحقول
        const fields = [
          { val: order.code, fn: v => update(ref(db, `orders/${order.id}`), { code: v }) },
          { val: order.phone1 || order.phone, fn: v => update(ref(db, `orders/${order.id}`), { phone1: v }) },
          { val: order.phone2, fn: v => update(ref(db, `orders/${order.id}`), { phone2: v }) },
          { city: true },
          { area: true },
          { val: order.address, textarea: true, fn: v => update(ref(db, `orders/${order.id}`), { address: v }) },
          { val: order.price, fn: v => update(ref(db, `orders/${order.id}`), { price: v }) },
          { val: order.quantity, fn: v => update(ref(db, `orders/${order.id}`), { quantity: v }) },
          { val: order.productName || order.product, dropdown: allProducts, fn: v => update(ref(db, `orders/${order.id}`), { productName: v }) },
          { val: order.notes, textarea: true, fn: v => update(ref(db, `orders/${order.id}`), { notes: v }) },
          { val: order.receiptNum, fn: v => update(ref(db, `orders/${order.id}`), { receiptNum: v }) },
          {
           
  val: order.status || "",
  dropdown: ["", "مثبت", "قيد المعالجة", "قيد التجهيز", "بانتظار البضاعة", "قيد التوصيل", "تم التسليم", "راجع", "رفض"],
  fn: async (newStatus) => {
const userName = currentUser;
    const orderRef = ref(db, `orders/${order.id}`);

    // جلب الطلب الحالي
    const snap = await get(orderRef);
    const existing = snap.exists() ? snap.val() : {};

    // تحديث الطلب بالاسم والتاريخ
    await update(orderRef, {
      status: newStatus,
      updatedBy: userName,
      updatedAt: new Date().toISOString(),
fixedBy:
  (existing.fixedBy && existing.fixedBy !== "غير معروف")
    ? existing.fixedBy
    : ((newStatus === "مثبت" || newStatus === "رفض") ? userName : existing.fixedBy || userName)
    });

    // إزالة الطلب من الصفحة إذا خرج من الفلترة الحالية
    const st = (newStatus || "").trim();
    const shouldHide =
      (currentStatus === "" && st !== "") ||
      (currentStatus !== "" && st !== currentStatus);
    if (shouldHide) tr.remove();
  }
}
,
          { val: order.orderDate || "-", readonly: true },
          { val: order.advertiser, fn: v => update(ref(db, `orders/${order.id}`), { advertiser: v }) }
        ];

        fields.forEach(f => {
          const td = document.createElement("td");
          if (f.readonly) td.textContent = f.val || "-";
          else if (f.textarea) td.appendChild(createTextarea(f.val, f.fn));
          else if (f.dropdown) td.appendChild(createDropdown(f.dropdown, f.val, f.fn));
          else if (f.city) {
            const cityDropdown = createDropdown(allCities, order.city || "", val => update(ref(db, `orders/${order.id}`), { city: val, area: "" }));
            td.appendChild(cityDropdown);
          } else if (f.area) {
            const areaDropdown = createDropdown(areas, order.area || "", val => update(ref(db, `orders/${order.id}`), { area: val }));
            td.appendChild(areaDropdown);
          } else td.appendChild(createEditableInput(f.val, f.fn));
          tr.appendChild(td);
        });

        ordersBody.appendChild(tr);
      });
    }

    // 🔍 البحث
    searchInput.addEventListener("input", e => {
      const q = e.target.value.trim();
      const filtered = allOrders.filter(o => Object.values(o).some(v => v && v.toString().includes(q)));
      renderOrders(filtered);
    });

    // 🗑 حذف المحددة
    document.getElementById("deleteSelected").addEventListener("click", () => {
      const checked = Array.from(document.querySelectorAll("input[type='checkbox']:checked"));
      if (checked.length === 0) return alert("لم يتم تحديد أي طلبات!");
      if (!confirm("هل أنت متأكد من حذف الطلبات المحددة؟")) return;
      checked.forEach(ch => remove(ref(db, `orders/${ch.dataset.id}`)));
      alert("✅ تم حذف الطلبات المحددة بنجاح");
    });

    document.getElementById("backBtn").addEventListener("click", () => window.location.href = "dashboard.html");



// 🚚 رفع الطلبات المثبتة إلى الوسيط (نسخة محدّثة)
// 🚚 رفع الطلبات المثبتة إلى الوسيط (نسخة مستقرة ومجربة)
// 🚀 رفع الطلبات المثبتة واحدة تلو الأخرى (نسخة أصلية قديمة)
document.getElementById("sendToWaseet").addEventListener("click", async () => {
  // 🟩 شريط الحالة بالأعلى
  let statusBar = document.getElementById("statusBar");
  if (!statusBar) {
    statusBar = document.createElement("div");
    statusBar.id = "statusBar";
    Object.assign(statusBar.style, {
      position: "fixed",
      top: "0",
      right: "0",
      left: "0",
      padding: "12px",
      textAlign: "center",
      backgroundColor: "#043B64",
      color: "white",
      fontSize: "15px",
      fontWeight: "bold",
      zIndex: "999999",
      transition: "0.4s ease"
    });
    document.body.appendChild(statusBar);
  }
  const showMsg = (text, color = "#043B64") => {
    statusBar.textContent = text;
    statusBar.style.backgroundColor = color;
    statusBar.style.display = "block";
  };

  try {
    showMsg("⏳ تسجيل الدخول إلى الوسيط...");

    // تسجيل الدخول للحصول على التوكن
    const loginResponse = await fetch("https://almurad.onrender.com/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: "ramadan@almurad",
        password: "ramadan1998@"
      })
    });

    const loginData = await loginResponse.json();
    const token = loginData.data?.token;
    if (!token) {
      showMsg("❌ فشل تسجيل الدخول إلى الوسيط", "#b30000");
      return;
    }

    // اختيار الطلبات المثبتة فقط
    const confirmedOrders = allOrders.filter(o => (o.status || "").trim() === "مثبت");
    if (confirmedOrders.length === 0) {
      showMsg("✅ لا توجد طلبات مثبتة حالياً.", "#28a745");
      setTimeout(() => (statusBar.style.display = "none"), 2500);
      return;
    }

    let sentCount = 0, failedCount = 0;
    showMsg(`🚀 جاري رفع ${confirmedOrders.length} طلب...`);

    // رفع الطلبات واحداً تلو الآخر
    for (const order of confirmedOrders) {
      try {
        const cityMatch = waseetCities.find(c => c.city_name === order.city);
        const regionMatch = waseetRegions.find(r => r.region_name === order.area);
        const cityId = cityMatch ? cityMatch.id : "";
        const regionId = regionMatch ? regionMatch.id : "";

        if (!cityId || !regionId) {
          failedCount++;
          continue;
        }

        const payload = {
          token,
          client_name: order.code || "زبون",
          client_mobile: normalizePhone(order.phone1 || ""),
          client_mobile2: order.phone2 ? normalizePhone(order.phone2) : "",
          city_id: cityId,
          region_id: regionId,
          location: order.address || "",
          type_name: order.productName || "منتج غير محدد",
          items_number: order.quantity?.toString() || "1",
          price: order.price?.toString() || "0",
          package_size: "1",
          merchant_notes: order.notes || "",
          replacement: 0,
        };

        // إرسال الطلب إلى السيرفر الوسيط (عن طريق سيرفرك الخاص)
        const response = await fetch("https://almurad.onrender.com/api/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await response.json();
        console.log("📬 استجابة الوسيط:", data);

        if (data.status === true && data.data?.qr_id) {
          await update(ref(db, `orders/${order.id}`), {
            status: "قيد التجهيز",
            receiptNum: data.data.qr_id.toString(),
            waseet_link: data.data.qr_link,
          });
          sentCount++;
        } else {
          failedCount++;
        }
      } catch (err) {
        failedCount++;
        console.error("❌ خطأ أثناء رفع الطلب:", err);
      }
    }

    showMsg(`✅ تم رفع ${sentCount} طلب بنجاح، ❌ فشل ${failedCount}.`, "#28a745");
    setTimeout(() => (statusBar.style.display = "none"), 4000);
  } catch (err) {
    console.error("❌ خطأ عام أثناء رفع الطلبات:", err);
    showMsg("❌ حدث خطأ أثناء رفع الطلبات.", "#b30000");
  }
});



// 🔢 دالة تنسيق رقم الهاتف
function normalizePhone(phone) {
  const arabicToEnglish = {
    '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
    '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9'
  };
  let cleaned = phone.replace(/[^\d٠-٩]/g, '');
  cleaned = cleaned.split('').map(c => arabicToEnglish[c] || c).join('');
  if (cleaned.startsWith("0")) return "+964" + cleaned.slice(1);
  if (cleaned.startsWith("7")) return "+964" + cleaned;
  if (!cleaned.startsWith("+964")) return "+964" + cleaned;
  return cleaned;
}
// 🔽 زر القائمة المنسدلة لأوامر الوسيط
const commandsBtn = document.getElementById("commandsBtn");
const commandsMenu = document.getElementById("commandsMenu");

commandsBtn.addEventListener("click", () => {
  commandsMenu.classList.toggle("show");
});

// إغلاق القائمة عند النقر خارجها
window.addEventListener("click", (e) => {
  if (!commandsBtn.contains(e.target)) commandsMenu.classList.remove("show");
});

// 🔄 تحديث الحالات من الوسيط
// 🔄 تحديث الحالات من الوسيط (نسخة محسّنة)
// 🔄 تحديث الحالات من الوسيط (Bulk - تحديث فوري دفعة واحدة)
document.getElementById("updateStatuses").addEventListener("click", async () => {
  // 🟩 شريط الإشعارات
  let statusBar = document.getElementById("statusBar");
  if (!statusBar) {
    statusBar = document.createElement("div");
    statusBar.id = "statusBar";
    Object.assign(statusBar.style, {
      position: "fixed",
      top: "0",
      right: "0",
      left: "0",
      padding: "12px",
      textAlign: "center",
      backgroundColor: "#043B64",
      color: "white",
      fontSize: "15px", 
      fontWeight: "bold",
      zIndex: "999999",
      transition: "0.4s ease"
    });
    document.body.appendChild(statusBar);
  }
  function showMsg(text, color = "#043B64") {
    statusBar.textContent = text;
    statusBar.style.backgroundColor = color;
    statusBar.style.display = "block";
  }

  try {
    showMsg("⏳ جاري تسجيل الدخول إلى الوسيط...");

    // 🔐 تسجيل الدخول للحصول على التوكن
    const loginResponse = await fetch("https://almurad.onrender.com/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: "ramadan@almurad",
        password: "ramadan1998@"
      })
    });

    const loginData = await loginResponse.json();
    const token = loginData.data?.token;
    if (!token) {
      showMsg("❌ فشل تسجيل الدخول إلى الوسيط", "#b30000");
      return;
    }

    // 🟠 الحالات التي يمكن تحديثها فقط
    const allowedToCheck = ["قيد التجهيز", "قيد التوصيل", "راجع"];

    // 🧩 المابينگ بين حالات الوسيط وحالات النظام
    const statusMapping = {
      "تم التسليم للزبون": "تم التسليم",
      "تم الاستلام من قبل المندوب": "قيد التوصيل",
      "ارجاع الى التاجر": "راجع",
      "تم الارجاع الى التاجر": "تم استلام الراجع",
      "في موقع فرز بغداد": "قيد التوصيل"
    };

    // 🔍 تصفية الطلبات التي تحتاج تحديث فقط
    const ordersToUpdate = allOrders.filter(
      o => allowedToCheck.includes((o.status || "").trim()) && o.receiptNum
    );

    if (ordersToUpdate.length === 0) {
      showMsg("✅ لا توجد طلبات تحتاج تحديث.", "#28a745");
      setTimeout(() => (statusBar.style.display = "none"), 2500);
      return;
    }

    showMsg(`🔄 جاري تحديث ${ordersToUpdate.length} طلب دفعة واحدة...`);

    // 🧾 تجميع كل أرقام الوصول دفعة واحدة
    const allIds = ordersToUpdate.map(o => o.receiptNum).join(",");

    // 📡 إرسال دفعة واحدة للسيرفر
    const response = await fetch("https://almurad.onrender.com/api/get-orders-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token, ids: allIds })
    });

    const data = await response.json();

    if (!data.status || !data.data) {
      showMsg("❌ فشل جلب الحالات من الوسيط.", "#b30000");
      return;
    }

    let updatedCount = 0;

    // 🔁 تحديث الطلبات كلها دفعة واحدة بالـ Firebase
    for (const orderData of data.data) {
      const apiStatus = (orderData.status || "").trim();
      const mappedStatus = statusMapping[apiStatus] || null;
      if (!mappedStatus) continue;

      const targetOrder = allOrders.find(
        o => (o.receiptNum || "").toString() === orderData.id.toString()
      );
      if (targetOrder) {
        await update(ref(db, `orders/${targetOrder.id}`), {
          status: mappedStatus
        });
        updatedCount++;

        if (apiStatus === "في موقع فرز بغداد") {
          await update(ref(db, `orders/${targetOrder.id}`), {
            notes:
              (targetOrder.notes || "") +
              (targetOrder.notes ? " | " : "") +
              "تحولت من موقع فرز"
          });
        }
      }
    }

    showMsg(`✅ تم تحديث ${updatedCount} طلب بنجاح.`, "#28a745");
    setTimeout(() => (statusBar.style.display = "none"), 3000);
  } catch (err) {
    console.error("❌ خطأ أثناء تحديث الحالات:", err);
    showMsg("❌ حدث خطأ أثناء تحديث الحالات.", "#b30000");
  }
});
// ✅ نافذة منبثقة لعرض تفاصيل الطلب بدون تحميل صفحة جديدة
function openOrderDetailsInline(order) {
  const overlay = document.createElement("div");
  Object.assign(overlay.style, {
    position: "fixed",
    top: "0", left: "0", right: "0", bottom: "0",
    background: "rgba(0,0,0,0.4)",
    display: "flex",
    justifyContent: "center",
    alignItems: "center",
    zIndex: "999999"
  });

  const box = document.createElement("div");
  Object.assign(box.style, {
    background: "white",
    borderRadius: "10px",
    padding: "20px",
    width: "90%",
    maxWidth: "600px",
    maxHeight: "90%",
    overflowY: "auto",
    direction: "rtl",
    textAlign: "right"
  });

  box.innerHTML = `
    <h3 style="text-align:center;color:#043B64;margin-top:0;">📋 تفاصيل الطلب</h3>
    <p><b>الكود:</b> ${order.code || "-"}</p>
    <p><b>المنتج:</b> ${order.productName || "-"}</p>
    <p><b>المدينة:</b> ${order.city || "-"}</p>
    <p><b>المنطقة:</b> ${order.area || "-"}</p>
    <p><b>العنوان:</b> ${order.address || "-"}</p>
    <p><b>السعر:</b> ${order.price || "-"}</p>
    <p><b>الكمية:</b> ${order.quantity || "-"}</p>
    <p><b>الملاحظات:</b> ${order.notes || "-"}</p>
    <p><b>رقم الهاتف:</b> ${order.phone1 || "-"}</p>
    <p><b>الحالة:</b> ${order.status || "-"}</p>
    <p><b>المعلن:</b> ${order.advertiser || "-"}</p>
    <div style="text-align:center;margin-top:20px;">
      <button id="closeOrderModal" style="background:#043B64;color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">إغلاق</button>
    </div>
  `;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  document.getElementById("closeOrderModal").addEventListener("click", () => overlay.remove());
}



  </script>
  <!-- ✅ نافذة تفاصيل الطلب الكاملة (منسوخة من صفحة التفاصيل) -->
  <div id="detailsModal" style="display:none;">
    <iframe id="detailsFrame" style="
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      border:none;
      z-index:999999;
    "></iframe>
  </div>

</body>
</html>
