<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family:"Tahoma",Arial; background:#f5f6fa; margin:0; padding:0; }
    header { background:#043B64; color:white; text-align:center; padding:12px; font-size:18px; }
    .container { padding:20px; }
    .back-btn { background:#FF6B2D; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; margin-bottom:20px; }
    .filters { margin-bottom:20px; }
    .filters label { margin-right:10px; font-weight:bold; color:#043B64; }
    .section { margin-bottom:40px; }
    .section h2 { color:#043B64; border-bottom:2px solid #043B64; padding-bottom:5px; margin-bottom:15px; }
    .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; }
    .stat-card { background:white; border-radius:10px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.05); text-align:center; }
    .stat-card h3 { margin:0; color:#043B64; }
    .stat-card p { margin:10px 0 0; font-size:16px; font-weight:bold; color:#333; }
    canvas { background:white; border-radius:10px; padding:10px; margin-top:15px; box-shadow:0 2px 8px rgba(0,0,0,0.05); width:100% !important; height:auto !important; }
  </style>
</head>
<body>
  <header>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©</header>
  <div class="container">
    <button class="back-btn" onclick="window.location.href='dashboard.html'">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>

    <div class="filters">
      <label>Ø§Ø®ØªØ± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©:</label>
      <select id="periodSelect">
        <option value="day">Ø§Ù„ÙŠÙˆÙ…</option>
        <option value="week">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
        <option value="month" selected>Ø§Ù„Ø´Ù‡Ø±</option>
        <option value="all">Ø§Ù„ÙƒÙ„</option>
      </select>
    </div>

    <!-- ğŸ“‹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
    <div class="section">
      <h2>ğŸ“‹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª</h2>
      <div class="stats-grid">
        <div class="stat-card"><h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ</h3><p id="stat_totalOrders">0</p></div>
        <div class="stat-card"><h3>Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</h3><p id="stat_newOrders">0</p></div>
        <div class="stat-card"><h3>Ø·Ù„Ø¨Ø§Øª Ù…Ø«Ø¨Ù‘ØªØ©</h3><p id="stat_fixedOrders">0</p></div>
        <div class="stat-card"><h3>ÙÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</h3><p id="stat_packingOrders">0</p></div>
        <div class="stat-card"><h3>Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„</h3><p id="stat_deliveringOrders">0</p></div>
        <div class="stat-card"><h3>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</h3><p id="stat_completedOrders">0</p></div>
        <div class="stat-card"><h3>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø§Ø¬Ø¹Ø©</h3><p id="stat_returnedOrders">0</p></div>
        <div class="stat-card"><h3>Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©</h3><p id="stat_rejectedOrders">0</p></div>
      </div>
    </div>

    <!-- ğŸ’° Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
    <div class="section">
      <h2>ğŸ’° Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© (ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙÙ‚Ø·)</h2>
      <div class="stats-grid">
        <div class="stat-card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ù„Ù‘Ù…Ø©</h3><p id="stat_totalSales">0 Ø¯.Ø¹</p></div>
        <div class="stat-card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„ØªÙˆØµÙŠÙ„</h3><p id="stat_totalDelivery">0 Ø¯.Ø¹</p></div>
        <div class="stat-card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹</h3><p id="stat_totalQuantity">0</p></div>
        <div class="stat-card"><h3>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</h3><p id="stat_netProfit">0 Ø¯.Ø¹</p></div>
        <div class="stat-card"><h3>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹</h3><p id="stat_returnRate">0%</p></div>
        <div class="stat-card"><h3>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø·Ù„Ø¨</h3><p id="stat_avgOrder">0 Ø¯.Ø¹</p></div>
      </div>
    </div>

    <!-- ğŸ“ˆ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="section"><h2>ğŸ“ˆ ØªØ·ÙˆØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­</h2><canvas id="chartSalesProfit"></canvas></div>
    <div class="section"><h2>ğŸ“¦ Ø£ÙƒØ«Ø± 10 Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø©</h2><canvas id="chartTopProducts"></canvas></div>
    <div class="section"><h2>âš ï¸ Ø£ÙƒØ«Ø± 10 Ù…Ù†ØªØ¬Ø§Øª Ø±Ø§Ø¬Ø¹Ø©</h2><canvas id="chartTopReturns"></canvas></div>
    <div class="section"><h2>ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2><canvas id="chartStatuses"></canvas></div>

    <!-- ğŸ’¡ Ù†ØµØ§Ø¦Ø­ -->
    <div class="section">
      <h2>ğŸ’¡ Ù†ØµØ§Ø¦Ø­ ÙˆØ§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù„Ù†Ù…Ùˆ</h2>
      <div id="tipsContainer"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
    import "https://cdn.jsdelivr.net/npm/chart.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
      authDomain: "almurad-system.firebaseapp.com",
      databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
      projectId: "almurad-system",
      storageBucket: "almurad-system.appspot.com",
      messagingSenderId: "911755824405",
      appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let charts = {};

    async function loadStatistics(period = "month") {
      const snapshot = await get(child(ref(db), "orders"));
      if (!snapshot.exists()) return;
      const orders = Object.values(snapshot.val());

      const statusCount = {"":0,"Ù…Ø«Ø¨Øª":0,"Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©":0,"Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²":0,"Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„":0,"ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…":0,"Ø±Ø§Ø¬Ø¹":0,"Ø±ÙØ¶":0};
      const dailySales = {}, dailyProfit = {}, productSales = {}, productReturns = {};

      let deliveredOrders = 0, deliveredAmount = 0, deliveredQuantity = 0;

      const now = new Date();
      let start = new Date();
      if (period === "day") start.setDate(now.getDate() - 1);
      else if (period === "week") start.setDate(now.getDate() - 7);
      else if (period === "month") start.setMonth(now.getMonth() - 1);
      else start = new Date(0);

      orders.forEach(o => {
        const st = (o.status || "").trim();
        if (statusCount.hasOwnProperty(st)) statusCount[st]++;
        const dateObj = o.orderDate ? new Date(o.orderDate) : now;
        if (dateObj < start) return;

        const price = parseFloat(o.price || 0);
        const qty = parseInt(o.quantity || 0);
        const prod = (o.productName || o.product || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ").trim();

        if (st === "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…") {
          deliveredOrders++;
          deliveredAmount += price;
          deliveredQuantity += qty;
        }

        const dayKey = dateObj.toISOString().split("T")[0];
        dailySales[dayKey] = (dailySales[dayKey] || 0) + price;
        dailyProfit[dayKey] = (dailyProfit[dayKey] || 0) + (price - 4000);

        if (st === "Ø±Ø§Ø¬Ø¹") productReturns[prod] = (productReturns[prod] || 0) + qty;
        else productSales[prod] = (productSales[prod] || 0) + qty;
      });

      const returnCount = statusCount["Ø±Ø§Ø¬Ø¹"] || 0;
      const returnRate = deliveredOrders > 0 ? ((returnCount / deliveredOrders) * 100).toFixed(2) : "0.00";
      const totalDeliveryCost = deliveredOrders * 4000;
      const netProfit = deliveredAmount - totalDeliveryCost;
      const avgOrder = deliveredOrders > 0 ? (deliveredAmount / deliveredOrders).toFixed(2) : 0;

      // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†ØµÙŠØ©
      document.getElementById("stat_totalOrders").textContent = orders.length;
      document.getElementById("stat_newOrders").textContent = statusCount[""];
      document.getElementById("stat_fixedOrders").textContent = statusCount["Ù…Ø«Ø¨Øª"];
      document.getElementById("stat_packingOrders").textContent = statusCount["Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²"];
      document.getElementById("stat_deliveringOrders").textContent = statusCount["Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„"];
      document.getElementById("stat_completedOrders").textContent = statusCount["ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"];
      document.getElementById("stat_returnedOrders").textContent = statusCount["Ø±Ø§Ø¬Ø¹"];
      document.getElementById("stat_rejectedOrders").textContent = statusCount["Ø±ÙØ¶"];

      document.getElementById("stat_totalSales").textContent = deliveredAmount.toLocaleString() + " Ø¯.Ø¹";
      document.getElementById("stat_totalDelivery").textContent = totalDeliveryCost.toLocaleString() + " Ø¯.Ø¹";
      document.getElementById("stat_totalQuantity").textContent = deliveredQuantity;
      document.getElementById("stat_netProfit").textContent = netProfit.toLocaleString() + " Ø¯.Ø¹";
      document.getElementById("stat_returnRate").textContent = returnRate + "%";
      document.getElementById("stat_avgOrder").textContent = avgOrder + " Ø¯.Ø¹";

      // âœ… Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
      const ctx1 = document.getElementById("chartSalesProfit").getContext("2d");
      if (charts.salesProfit) charts.salesProfit.destroy();
      charts.salesProfit = new Chart(ctx1, {
        type: "line",
        data: {
          labels: Object.keys(dailySales),
          datasets: [
            { label: "ğŸ’µ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", data: Object.values(dailySales), borderColor: "#043B64", fill: false },
            { label: "ğŸ“ˆ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­", data: Object.values(dailyProfit), borderColor: "#FF6B2D", fill: false }
          ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      const arrSales = Object.entries(productSales).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const arrReturns = Object.entries(productReturns).sort((a,b)=>b[1]-a[1]).slice(0,10);

      const ctx2 = document.getElementById("chartTopProducts").getContext("2d");
      if (charts.topProducts) charts.topProducts.destroy();
      charts.topProducts = new Chart(ctx2, {
        type: "bar",
        data: { labels: arrSales.map(i=>i[0]), datasets: [{ label:"ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", data: arrSales.map(i=>i[1]), backgroundColor:"#043B64" }] },
        options: { plugins:{legend:{display:false}} }
      });

      const ctx3 = document.getElementById("chartTopReturns").getContext("2d");
      if (charts.topReturns) charts.topReturns.destroy();
      charts.topReturns = new Chart(ctx3, {
        type: "bar",
        data: { labels: arrReturns.map(i=>i[0]), datasets: [{ label:"ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹", data: arrReturns.map(i=>i[1]), backgroundColor:"#d93025" }] },
        options: { plugins:{legend:{display:false}} }
      });

      const ctx4 = document.getElementById("chartStatuses").getContext("2d");
      if (charts.statuses) charts.statuses.destroy();
      charts.statuses = new Chart(ctx4, {
        type: "doughnut",
        data: { labels: Object.keys(statusCount), datasets: [{ data: Object.values(statusCount), backgroundColor: ["#6C757D","#0D6EFD","#198754","#FFC107","#17A2B8","#28A745","#DC3545","#6F42C1"] }] },
        options: { plugins: { legend: { position: "right" } } }
      });

      // âœ… Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø°ÙƒÙŠØ©
      const tips = [];
      if (parseFloat(returnRate) > 5) tips.push("âš ï¸ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø±ØªÙØ¹Ø© â€” Ø±Ø§Ø¬Ø¹ Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ØªØºÙ„ÙŠÙ.");
      if (netProfit < 0) tips.push("ğŸš¨ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø¨Ø§Ù„Ø³Ø§Ù„Ø¨ â€” ØªØ£ÙƒØ¯ Ù…Ù† ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù† Ø£Ùˆ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±.");
      if (avgOrder < 10000) tips.push("ğŸ’¡ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø·Ù„Ø¨ Ù…Ù†Ø®ÙØ¶ â€” ÙÙƒÙ‘Ø± Ø¨Ø¹Ø±ÙˆØ¶ Ù„ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©.");
      if (arrSales[0]) tips.push(`ğŸ”¥ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ù‹Ø§: ${arrSales[0][0]} (${arrSales[0][1]} Ù‚Ø·Ø¹Ø©).`);

      const tipContainer = document.getElementById("tipsContainer");
      tipContainer.innerHTML = "";
      tips.forEach(t => {
        const div = document.createElement("div");
        div.textContent = "â€¢ " + t;
        tipContainer.appendChild(div);
      });
    }

    document.getElementById("periodSelect").addEventListener("change", e => loadStatistics(e.target.value));
    document.addEventListener("DOMContentLoaded", ()=> loadStatistics("month"));
  </script>
</body>
</html>
