<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>📊 الإحصائيات - نظام المراد</title>

  <!-- خط مشابه للي طلبته -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Chart.js (موجود في الهيدر) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --main-blue:#043B64;
      --accent:#FF6B2D;
      --card-bg:#ffffff;
      --muted:#6b7280;
      --surface:#f5f6fa;
    }
    body{font-family:'Tajawal',sans-serif;background:var(--surface);margin:0;color:#222}
    header{background:var(--main-blue);color:#fff;padding:14px 18px;text-align:center;font-weight:700}
    .container{max-width:1200px;margin:20px auto;padding:16px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
    .controls select, .controls input[type="date"], .controls button {padding:8px 10px;border-radius:8px;border:1px solid #ddd;font-size:14px}
    .controls button {background:var(--main-blue);color:#fff;border:0;cursor:pointer}
    .controls .preset {background:transparent;color:var(--main-blue);border:1px solid #ddd;cursor:pointer}
    .grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:18px}
    .card {background:var(--card-bg);padding:16px;border-radius:10px;box-shadow:0 4px 12px rgba(6,21,34,0.04);text-align:center}
    .card h3{margin:0;color:var(--main-blue);font-size:15px}
    .card p{margin:6px 0 0;font-size:20px;font-weight:700}
    .charts {display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full {grid-column:1/-1}
    canvas{background:#fff;border-radius:8px;padding:8px}
    .table-wrap{margin-top:18px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 6px 14px rgba(6,21,34,0.04)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:center}
    th{background:#f8fafc;color:var(--main-blue)}
    .small{font-size:12px;color:var(--muted)}
    @media(max-width:900px){ .charts {grid-template-columns:1fr} }
    .toolbar {display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .export-btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <header>📊 صفحة الإحصائيات - نظام المراد</header>

  <div class="container">
    <!-- فلترة + إعدادات -->
    <div class="controls">
      <div class="toolbar">
        <label class="small">من:</label>
        <input type="date" id="fromDate">
        <label class="small">إلى:</label>
        <input type="date" id="toDate">
        <select id="statusFilter" title="فلتر الحالة">
          <option value="">كل الحالات</option>
          <!-- حالات ستُملأ ديناميكياً -->
        </select>

        <select id="granularity" title="المقاس الزمني">
          <option value="day">يومي</option>
          <option value="week">أسبوعي</option>
          <option value="month" selected>شهري</option>
          <option value="all">الكل</option>
        </select>

        <button id="applyBtn">تطبيق الفلتر</button>
        <button class="preset" id="todayBtn">اليوم</button>
        <button class="preset" id="weekBtn">آخر 7 أيام</button>
        <button class="preset" id="monthBtn">آخر 30 يوم</button>
        <button class="preset" id="allBtn">الكل</button>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="muted">عدد الطلبات المظاهرة: <span id="shownCount">0</span></div>
        <button class="export-btn" id="downloadCsv">تحميل CSV</button>
      </div>
    </div>

    <!-- عدادات الحالة -->
    <div id="summary" class="grid"></div>

    <!-- الرسوم البيانية -->
    <div class="charts">
      <div class="card">
        <h3>📈 تطور المبيعات حسب التاريخ</h3>
        <canvas id="chartLine" height="160"></canvas>
      </div>

      <div class="card">
        <h3>📊 توزيع حالات الطلب</h3>
        <canvas id="chartDonut" height="160"></canvas>
      </div>

      <div class="card full">
        <h3>🛒 أكثر المنتجات مبيعاً (Top 10)</h3>
        <canvas id="chartBar" height="160"></canvas>
      </div>
    </div>

    <!-- جدول النتائج (جدول واحد للفلترة كلها) -->
    <div class="table-wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="muted">قائمة الطلبات المفلترة (جدول واحد)</div>
        <div class="muted small">اضغط على صف لعرض تفاصيل</div>
      </div>
      <div style="overflow:auto;max-height:420px">
        <table id="ordersTable">
          <thead>
            <tr>
              <th>#</th>
              <th>الكود</th>
              <th>المنتج</th>
              <th>السعر</th>
              <th>الكمية</th>
              <th>الهاتف</th>
              <th>المدينة</th>
              <th>المنطقة</th>
              <th>الحالة</th>
              <th>تاريخ الطلب</th>
              <th>المعلن</th>
            </tr>
          </thead>
          <tbody id="ordersTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- سكربتات: Firebase + منطق الإحصائيات -->
  <script type="module">
    // ----- تهيئة Firebase (نفس config عندك) -----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, get, onValue, child } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
      authDomain: "almurad-system.firebaseapp.com",
      databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
      projectId: "almurad-system",
      storageBucket: "almurad-system.appspot.com",
      messagingSenderId: "911755824405",
      appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ----- عناصر الواجهة -----
    const fromDateEl = document.getElementById('fromDate');
    const toDateEl = document.getElementById('toDate');
    const applyBtn = document.getElementById('applyBtn');
    const statusFilter = document.getElementById('statusFilter');
    const granularityEl = document.getElementById('granularity');
    const summaryEl = document.getElementById('summary');
    const shownCountEl = document.getElementById('shownCount');
    const ordersTbody = document.getElementById('ordersTbody');
    const downloadCsvBtn = document.getElementById('downloadCsv');

    // Charts
    let chartLine = null, chartDonut = null, chartBar = null;

    // الحالة الافتراضية للقائمة (نضيف حالاتك مع "تم استلام الراجع")
    const defaultStatuses = ["", "مثبت", "قيد المعالجة", "قيد التجهيز", "بانتظار البضاعة", "قيد التوصيل", "تم التسليم", "راجع", "تم استلام الراجع", "رفض"];

    // تحميل الطلبات من Firebase (مباشر، ونستخدم onValue لكي تتحدّث تلقائياً)
    const ordersRef = ref(db, 'orders');

    let allOrders = []; // المصفوفة الكاملة من Firebase

    onValue(ordersRef, (snap) => {
      if (!snap.exists()) {
        allOrders = [];
        renderAll([]);
        return;
      }
      const obj = snap.val();
      allOrders = Object.entries(obj).map(([id, val]) => ({ id, ...val }));
      // تحديث dropdown الحالات حسب الموجود أيضاً (دمج مع الافتراضي)
      populateStatusFilter();
      // عرض أولي: بدون فلترة (الكل)
      applyFiltersAndRender();
    });

    // ملئ قائمة الحالات
    function populateStatusFilter() {
      const found = new Set(defaultStatuses);
      allOrders.forEach(o => {
        const st = (o.status || "").toString().trim();
        if (st) found.add(st);
      });
      // افراغ العنصر ثم إعادة ملئه
      statusFilter.innerHTML = '<option value="">كل الحالات</option>';
      Array.from(found).forEach(s => {
        // لا نريد إضافة القيمة الفارغة مرتين
        if (s === "") return;
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s;
        statusFilter.appendChild(opt);
      });
    }

    // مساعد لتحويل قيم التاريخ
    function toDateObj(d) {
      if (!d) return null;
      // إذا كان تاريخ ISO
      const n = new Date(d);
      if (!isNaN(n)) return n;
      // إذا كان رقم (timestamp)
      const t = Number(d);
      if (!isNaN(t)) return new Date(t);
      return null;
    }

    // دالة تطبيق الفلاتر وحساب الإحصائيات و الرندر
    function applyFiltersAndRender() {
      // قراءة الفلاتر
      const fromVal = fromDateEl.value ? new Date(fromDateEl.value + 'T00:00:00') : null;
      const toVal = toDateEl.value ? new Date(toDateEl.value + 'T23:59:59') : null;
      const statusVal = statusFilter.value;
      const gran = granularityEl.value;

      // تصفية حسب التاريخ والحالة
      const filtered = allOrders.filter(o => {
        const dt = toDateObj(o.orderDate) || toDateObj(o.createdAt) || new Date();
        if (!dt) return false;
        if (fromVal && dt < fromVal) return false;
        if (toVal && dt > toVal) return false;
        if (statusVal && ((o.status||'').toString().trim() !== statusVal)) return false;
        return true;
      });

      renderAll(filtered, gran);
    }

    // renderAll: يعرض العدادات والرسوم والجدول
    function renderAll(filtered, granularity = 'month') {
      // --- ملخص العدادات لكل حالة (نحسب باستخدام كل الحالات الموجودة) ---
      const statusCounts = {};
      // نضمن أن كل الحالات الافتراضية موجودة
      defaultStatuses.forEach(s => statusCounts[s] = 0);

      filtered.forEach(o => {
        const st = (o.status || '').toString().trim();
        statusCounts[st] = (statusCounts[st] || 0) + 1;
      });

      // render summary
      summaryEl.innerHTML = '';
      Object.keys(statusCounts).forEach(key => {
        // skip empty key if you want rename: show as "طلبات جديدة"
        const label = (key === "" ? "طلبات جديدة" : key);
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<h3>${label}</h3><p>${statusCounts[key] || 0}</p>`;
        summaryEl.appendChild(div);
      });

      // --- جدول الطلبات (واحد فقط) ---
      ordersTbody.innerHTML = '';
      filtered.sort((a,b) => {
        const da = toDateObj(a.orderDate) || new Date(0);
        const db = toDateObj(b.orderDate) || new Date(0);
        return db - da; // تصاعدي حسب التاريخ الأحدث أولاً
      }).forEach((o, idx) => {
        const tr = document.createElement('tr');
        const dt = toDateObj(o.orderDate);
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${o.code || '-'}</td>
          <td>${(o.productName || o.product) || '-'}</td>
          <td>${o.price || 0}</td>
          <td>${o.quantity || 0}</td>
          <td>${o.phone1 || o.phone || '-'}</td>
          <td>${o.city || '-'}</td>
          <td>${o.area || '-'}</td>
          <td>${o.status || '-'}</td>
          <td>${dt ? dt.toLocaleString() : '-'}</td>
          <td>${o.advertiser || '-'}</td>
        `;
        tr.style.cursor = 'pointer';
        tr.addEventListener('click', () => openInlineDetails(o));
        ordersTbody.appendChild(tr);
      });

      shownCountEl.textContent = filtered.length;

      // --- بيانات الرسوم البيانية ---
      buildCharts(filtered, statusCounts, granularity);
    }

    // فتح تفاصيل الطلب داخل مودال بسيط
    function openInlineDetails(order) {
      const overlay = document.createElement('div');
      Object.assign(overlay.style, {
        position:'fixed',left:0,top:0,right:0,bottom:0,background:'rgba(0,0,0,0.4)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:99999
      });
      const box = document.createElement('div');
      Object.assign(box.style, {background:'#fff',padding:'18px',borderRadius:'10px',minWidth:'300px',maxWidth:'720px',direction:'rtl',textAlign:'right',maxHeight:'90%',overflow:'auto'});
      const dt = toDateObj(order.orderDate);
      box.innerHTML = `
        <h3 style="margin-top:0;color:${getComputedStyle(document.documentElement).getPropertyValue('--main-blue') || '#043B64'}">تفاصيل الطلب</h3>
        <p><b>الكود:</b> ${order.code || '-'}</p>
        <p><b>المنتج:</b> ${(order.productName || order.product) || '-'}</p>
        <p><b>الكمية:</b> ${order.quantity || '-'}</p>
        <p><b>السعر:</b> ${order.price || '-'}</p>
        <p><b>الهاتف:</b> ${order.phone1 || order.phone || '-'}</p>
        <p><b>العنوان:</b> ${(order.city||'-') + ' - ' + (order.area||'-')}</p>
        <p><b>الحالة:</b> ${order.status || '-'}</p>
        <p><b>تاريخ الطلب:</b> ${dt ? dt.toLocaleString() : '-'}</p>
        <p><b>الملاحظات:</b> ${order.notes || '-'}</p>
        <div style="text-align:center;margin-top:12px"><button id="closeDetails" style="background:var(--main-blue);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">إغلاق</button></div>
      `;
      overlay.appendChild(box);
      document.body.appendChild(overlay);
      document.getElementById('closeDetails').addEventListener('click', () => overlay.remove());
    }

    // بناء الرسوم البيانية
    function buildCharts(filtered, statusCounts, granularity) {
      // --- خط تطور المبيعات يومياً (أو بالأسبوع/الشهر) ---
      const salesByDate = {}; // key -> مبلغ إجمالي
      const profitByDate = {}; // مثال: يمكن حساب ربح تقريبي إن أردت
      const qtyByProduct = {};
      const returnsByProduct = {};

      filtered.forEach(o => {
        const dt = toDateObj(o.orderDate) || new Date();
        // التجميع حسب granularity
        let key;
        if (granularity === 'day') key = dt.toISOString().split('T')[0];
        else if (granularity === 'week') {
          const start = new Date(dt); // حساب بداية الأسبوع (الاثنين مثلاً)
          const day = start.getDay(); // 0..6
          const diff = start.getDate() - day + (day === 0 ? -6 : 1); // الاثنين كبداية
          start.setDate(diff);
          key = start.toISOString().split('T')[0];
        } else if (granularity === 'month') {
          key = dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0');
        } else key = dt.toISOString().split('T')[0];

        const price = Number(o.price || 0);
        const qty = Number(o.quantity || 0);

        salesByDate[key] = (salesByDate[key] || 0) + price;
        // profitByDate[key] = (profitByDate[key] || 0) + (price - 4000); // مثال
        const prod = (o.productName || o.product || 'غير معروف').toString();
        if ((o.status||'').toString().trim() === 'راجع') returnsByProduct[prod] = (returnsByProduct[prod] || 0) + qty;
        else qtyByProduct[prod] = (qtyByProduct[prod] || 0) + qty;
      });

      // Line chart data (sorted keys)
      const labelsLine = Object.keys(salesByDate).sort();
      const dataLine = labelsLine.map(k => salesByDate[k]);

      // Donut chart for statuses
      const statusLabels = Object.keys(statusCounts).filter(k => k !== undefined);
      const statusValues = statusLabels.map(k => statusCounts[k] || 0);

      // Top products
      const topProducts = Object.entries(qtyByProduct).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const topLabels = topProducts.map(p=>p[0]);
      const topValues = topProducts.map(p=>p[1]);

      // --- render or update charts ---
      const ctxLine = document.getElementById('chartLine').getContext('2d');
      if (chartLine) chartLine.destroy();
      chartLine = new Chart(ctxLine, {
        type: 'line',
        data: { labels: labelsLine, datasets: [{ label:'إجمالي المبيعات', data: dataLine, borderColor: '#043B64', backgroundColor:'rgba(4,59,100,0.08)', fill:true, tension:0.2 }] },
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });

      const ctxDonut = document.getElementById('chartDonut').getContext('2d');
      if (chartDonut) chartDonut.destroy();
      chartDonut = new Chart(ctxDonut, {
        type: 'doughnut',
        data: { labels: statusLabels.map(k => k==='' ? 'جديدة' : k), datasets:[{ data: statusValues, backgroundColor: ['#6C757D','#0D6EFD','#198754','#FFC107','#FF6B2D','#17A2B8','#28A745','#EF476F','#5D3FD3','#D6336C'] }] },
        options: { responsive:true, plugins:{legend:{position:'right'}} }
      });

      const ctxBar = document.getElementById('chartBar').getContext('2d');
      if (chartBar) chartBar.destroy();
      chartBar = new Chart(ctxBar, {
        type: 'bar',
        data: { labels: topLabels, datasets:[{ label:'الكمية', data: topValues, backgroundColor: '#FF6B2D' }] },
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    }

    // event listeners للفلاتر و أزرار الاختصارات
    applyBtn.addEventListener('click', () => applyFiltersAndRender());
    document.getElementById('todayBtn').addEventListener('click', ()=> {
      const d = new Date(); fromDateEl.value = d.toISOString().split('T')[0]; toDateEl.value = d.toISOString().split('T')[0];
      applyFiltersAndRender();
    });
    document.getElementById('weekBtn').addEventListener('click', ()=> {
      const to = new Date(); const from = new Date(); from.setDate(to.getDate()-6);
      fromDateEl.value = from.toISOString().split('T')[0]; toDateEl.value = to.toISOString().split('T')[0];
      applyFiltersAndRender();
    });
    document.getElementById('monthBtn').addEventListener('click', ()=> {
      const to = new Date(); const from = new Date(); from.setDate(to.getDate()-29);
      fromDateEl.value = from.toISOString().split('T')[0]; toDateEl.value = to.toISOString().split('T')[0];
      applyFiltersAndRender();
    });
    document.getElementById('allBtn').addEventListener('click', ()=> {
      fromDateEl.value = ''; toDateEl.value = ''; applyFiltersAndRender();
    });

    // تحميل CSV للطلبات المفلترة
    downloadCsvBtn.addEventListener('click', () => {
      // نجمع البيانات المرئية في الجدول
      const rows = Array.from(document.querySelectorAll('#ordersTbody tr')).map(tr => {
        return Array.from(tr.children).map(td => td.textContent.trim().replace(/\n/g,' '));
      });
      if (!rows.length) return alert('لا توجد بيانات للتصدير');
      let csv = 'رقم,كود,منتج,سعر,كمية,هاتف,مدينة,منطقة,حالة,تاريخ,معلن\n';
      rows.forEach(r => { csv += r.join(',') + '\n'; });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'orders_stats.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // تهيئة أولية: نعرض "الكل" إذا لا يوجد شيء
    // (onValue سيستدعي applyFiltersAndRender عند تحميل البيانات)
  </script>
</body>
</html>

