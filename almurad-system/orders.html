<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>الطلبات - نظام المراد</title>
  <style>
    body {
      font-family: Tahoma, Arial;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }
    header {
      background: #043B64;
      color: white;
      text-align: center;
      padding: 12px;
      font-size: 18px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
    }
    .back-btn {
      background: #043B64;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 13px;
    }
    .delete-btn {
      background: #d93025;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 13px;
    }
    .search-bar {
      text-align: center;
      margin: 10px 0 15px;
    }
    .search-bar input {
      width: 60%;
      padding: 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .table-container {
      width: 100%;
      overflow-x: auto;
      white-space: nowrap;
      padding: 10px;
    }
    table {
      width: max-content;
      min-width: 1400px;
      margin: 0 auto;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 6px 8px;
      text-align: center;
      border-bottom: 1px solid #ddd;
      font-size: 12px;
    }
    th { background: #043B64; color: white; }
    tr:hover { background: #f9fafb; }
    input, select, textarea {
      font-size: 12px;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
    }
    textarea { resize: vertical; height: 40px; }
    button {
      background: #FF6B2D;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }
    /* 🔸 منع التقريب التلقائي بالموبايل */
input, select, textarea {
  font-size: 16px !important;
}

    button:hover { opacity: 0.9; }
  </style>
</head>
<body>

  <header id="pageTitle">📦 الطلبات</header>

  <div class="top-bar">
    <button class="back-btn" id="backBtn">🔙 رجوع إلى لوحة التحكم</button>
    <button class="delete-btn" id="deleteSelected">🗑 حذف المحددة</button>
    <button class="back-btn" id="sendToWaseet">🚚 رفع الطلبات المثبتة للوسيط</button>

  </div>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="🔍 ابحث عن أي معلومة...">
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>اختيار</th>
          <th>#</th>
          <th>تفاصيل</th>
          <th>الكود</th>
          <th>رقم الهاتف</th>
          <th>الرقم الثاني</th>
          <th>المحافظة</th>
          <th>المنطقة</th>
          <th>وصف العنوان</th>
          <th>السعر</th>
          <th>عدد القطع</th>
          <th>اسم المنتج</th>
          <th>الملاحظات</th>
          <th>رقم الوصل</th>
          <th>الحالة</th>
          <th>تاريخ الطلب</th>
          <th>المعلن</th>
        </tr>
      </thead>
      <tbody id="ordersBody">
        <tr><td colspan="17">⏳ جاري تحميل الطلبات...</td></tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    import { waseetCities } from "./waseetCities.js";
import { waseetRegions } from "./waseetRegions.js";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
    import { citiesData, allCities } from "./citiesData.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
      authDomain: "almurad-system.firebaseapp.com",
      databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
      projectId: "almurad-system",
      storageBucket: "almurad-system.appspot.com",
      messagingSenderId: "911755824405",
      appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const ordersBody = document.getElementById("ordersBody");
    const searchInput = document.getElementById("searchInput");

    let allProducts = [];
    let allOrders = [];
    const urlParams = new URLSearchParams(window.location.search);
    const currentStatus = decodeURIComponent(urlParams.get("status") || "");

    // تحميل المنتجات
    const productsRef = ref(db, "products");
    onValue(productsRef, (snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        allProducts = Object.values(data).map(p => p.name || p);
      }
    });

    // تحميل الطلبات مع فلترة دقيقة
    const ordersRef = ref(db, "orders");
    onValue(ordersRef, (snapshot) => {
      if (!snapshot.exists()) {
        ordersBody.innerHTML = `<tr><td colspan="17">🚫 لا توجد طلبات</td></tr>`;
        return;
      }

      allOrders = Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data }));
      
      // فلترة حسب الحالة الحالية
      const filtered = allOrders.filter(o => {
        const st = (o.status || "").trim();
        return currentStatus === "" 
          ? (st === "" || st === null)
          : st === currentStatus;
      });

      renderOrders(filtered);
    });

    // أدوات الإدخال والمنسدلات
    function createEditableInput(value, onSave) {
      const input = document.createElement("input");
      input.value = value || "";
      input.addEventListener("change", e => onSave(e.target.value));
      return input;
    }

    function createTextarea(value, onSave) {
      const t = document.createElement("textarea");
      t.value = value || "";
      t.addEventListener("change", e => onSave(e.target.value));
      return t;
    }

    function createDropdown(options, selected, onChange) {
      const wrapper = document.createElement("div");
      const input = document.createElement("input");
      input.type = "text";
      input.value = selected || "";
      input.placeholder = "اختر...";
      input.style.cursor = "pointer";

      const dropdown = document.createElement("div");
      Object.assign(dropdown.style, {
        position: "fixed",
        background: "#fff",
        border: "1px solid #ccc",
        borderRadius: "6px",
        boxShadow: "0 3px 10px rgba(0,0,0,0.2)",
        maxHeight: "200px",
        overflowY: "auto",
        zIndex: "999999",
        display: "none",
        fontSize: "12px"
      });

      function renderList(filter = "") {
        dropdown.innerHTML = "";
        options.filter(o => o.includes(filter)).forEach(o => {
          const opt = document.createElement("div");
          opt.textContent = o;
          opt.style.padding = "5px 8px";
          opt.style.cursor = "pointer";
          opt.addEventListener("click", () => {
            input.value = o;
            dropdown.style.display = "none";
            onChange(o);
          });
          dropdown.appendChild(opt);
        });
      }

      input.addEventListener("focus", () => {
        const rect = input.getBoundingClientRect();
        dropdown.style.top = rect.bottom + "px";
        dropdown.style.left = rect.left + "px";
        dropdown.style.width = rect.width + "px";
        dropdown.style.display = "block";
        renderList();
      });

      input.addEventListener("input", e => renderList(e.target.value.trim()));
      document.addEventListener("click", e => {
        if (!wrapper.contains(e.target)) dropdown.style.display = "none";
      });

      wrapper.appendChild(input);
      document.body.appendChild(dropdown);
      return wrapper;
    }

    // عرض الطلبات
    function renderOrders(orders) {
      ordersBody.innerHTML = "";
      if (orders.length === 0) {
        ordersBody.innerHTML = `<tr><td colspan="17">🚫 لا توجد طلبات في هذه الحالة</td></tr>`;
        return;
      }

      orders.forEach((order, index) => {
        const tr = document.createElement("tr");
        const areas = citiesData[order.city] || [];

        // ✅ اختيار
        const selectTd = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.dataset.id = order.id;
        selectTd.appendChild(checkbox);
        tr.appendChild(selectTd);

        // 🔢 تسلسل
        const indexTd = document.createElement("td");
        indexTd.textContent = index + 1;
        tr.appendChild(indexTd);

        // 🔍 تفاصيل
        const detailsTd = document.createElement("td");
        const detailsBtn = document.createElement("button");
        detailsBtn.textContent = "🔍 تفاصيل";
        detailsBtn.style.background = "#FF6B2D";
        detailsBtn.addEventListener("click", () => {
          localStorage.setItem("selectedOrder", order.id);
          window.location.href = "order-details.html";
        });
        detailsTd.appendChild(detailsBtn);
        tr.appendChild(detailsTd);

        // بقية الحقول
        const fields = [
          { val: order.code, fn: v => update(ref(db, `orders/${order.id}`), { code: v }) },
          { val: order.phone1 || order.phone, fn: v => update(ref(db, `orders/${order.id}`), { phone1: v }) },
          { val: order.phone2, fn: v => update(ref(db, `orders/${order.id}`), { phone2: v }) },
          { city: true },
          { area: true },
          { val: order.address, textarea: true, fn: v => update(ref(db, `orders/${order.id}`), { address: v }) },
          { val: order.price, fn: v => update(ref(db, `orders/${order.id}`), { price: v }) },
          { val: order.quantity, fn: v => update(ref(db, `orders/${order.id}`), { quantity: v }) },
          { val: order.productName || order.product, dropdown: allProducts, fn: v => update(ref(db, `orders/${order.id}`), { productName: v }) },
          { val: order.notes, textarea: true, fn: v => update(ref(db, `orders/${order.id}`), { notes: v }) },
          { val: order.receiptNum, fn: v => update(ref(db, `orders/${order.id}`), { receiptNum: v }) },
          {
            val: order.status || "",
            dropdown: ["", "مثبت", "قيد المعالجة", "قيد التجهيز", "قيد التوصيل", "تم التسليم", "راجع", "رفض"],
            fn: v => {
              update(ref(db, `orders/${order.id}`), { status: v }).then(() => {
                // إخفاء الطلب فوريًا عند تغيّر الحالة
                const st = (v || "").trim();
                const shouldHide =
                  (currentStatus === "" && st !== "") ||
                  (currentStatus !== "" && st !== currentStatus);
                if (shouldHide) tr.remove();
              });
            }
          },
          { val: order.orderDate || "-", readonly: true },
          { val: order.advertiser, fn: v => update(ref(db, `orders/${order.id}`), { advertiser: v }) }
        ];

        fields.forEach(f => {
          const td = document.createElement("td");
          if (f.readonly) td.textContent = f.val || "-";
          else if (f.textarea) td.appendChild(createTextarea(f.val, f.fn));
          else if (f.dropdown) td.appendChild(createDropdown(f.dropdown, f.val, f.fn));
          else if (f.city) {
            const cityDropdown = createDropdown(allCities, order.city || "", val => update(ref(db, `orders/${order.id}`), { city: val, area: "" }));
            td.appendChild(cityDropdown);
          } else if (f.area) {
            const areaDropdown = createDropdown(areas, order.area || "", val => update(ref(db, `orders/${order.id}`), { area: val }));
            td.appendChild(areaDropdown);
          } else td.appendChild(createEditableInput(f.val, f.fn));
          tr.appendChild(td);
        });

        ordersBody.appendChild(tr);
      });
    }

    // 🔍 البحث
    searchInput.addEventListener("input", e => {
      const q = e.target.value.trim();
      const filtered = allOrders.filter(o => Object.values(o).some(v => v && v.toString().includes(q)));
      renderOrders(filtered);
    });

    // 🗑 حذف المحددة
    document.getElementById("deleteSelected").addEventListener("click", () => {
      const checked = Array.from(document.querySelectorAll("input[type='checkbox']:checked"));
      if (checked.length === 0) return alert("لم يتم تحديد أي طلبات!");
      if (!confirm("هل أنت متأكد من حذف الطلبات المحددة؟")) return;
      checked.forEach(ch => remove(ref(db, `orders/${ch.dataset.id}`)));
      alert("✅ تم حذف الطلبات المحددة بنجاح");
    });

    document.getElementById("backBtn").addEventListener("click", () => window.location.href = "dashboard.html");



// 🚚 رفع الطلبات المثبتة إلى الوسيط (نسخة محدّثة)
// 🚚 رفع الطلبات المثبتة إلى الوسيط (نسخة مستقرة ومجربة)
document.getElementById("sendToWaseet").addEventListener("click", async () => {
  if (!confirm("هل تريد رفع الطلبات المثبتة إلى الوسيط؟")) return;

  try {
    console.log("⏳ تسجيل الدخول إلى الوسيط...");

    // تسجيل الدخول للحصول على التوكن
   const formData = new FormData();
formData.append("username", "ramadan@almurad");
formData.append("password", "ramadan1998@");

const loginResponse = await fetch("https://api.alwaseet-iq.net/v1/merchant/login", {
  method: "POST",
  body: formData
});


    const loginData = await loginResponse.json();
    const token = loginData.data?.token;
    if (!token) return alert("❌ فشل تسجيل الدخول إلى الوسيط.");

    // اختيار الطلبات المثبتة فقط
    const confirmedOrders = allOrders.filter(o => (o.status || "").trim() === "مثبت");
    if (confirmedOrders.length === 0)
      return alert("✅ لا توجد طلبات مثبتة حالياً.");

    let sentCount = 0;
    let failedCount = 0;

    // 🔹 التحقق من صحة الطلب
    function validateOrder(order, cityId, regionId) {
      const issues = [];
      if (!order.code) issues.push("❌ الاسم مفقود");
      const phone = (order.phone1 || "").trim();
      if (!phone) issues.push("❌ رقم الهاتف مفقود");
      if (!cityId) issues.push("❌ city_id مفقود");
      if (!regionId) issues.push("❌ region_id مفقود");
      if (!order.price || isNaN(order.price)) issues.push("❌ السعر غير صالح");
      if (!order.quantity || isNaN(order.quantity)) issues.push("❌ العدد غير صالح");
      return issues;
    }

    // 🚀 رفع كل الطلبات المثبتة واحدة تلو الأخرى
    for (const order of confirmedOrders) {
      const cityMatch = waseetCities.find(c => c.city_name === order.city);
      const regionMatch = waseetRegions.find(r => r.region_name === order.area);
      const cityId = cityMatch ? cityMatch.id : "";
      const regionId = regionMatch ? regionMatch.id : "";

      // تحقق من صلاحية الطلب
      const issues = validateOrder(order, cityId, regionId);
      if (issues.length > 0) {
        console.warn(`⚠️ الطلب ${order.id} يحتوي على مشاكل:`, issues.join(", "));
        failedCount++;
        continue;
      }

      // البيانات المطلوبة للإرسال
      const payload = {
        client_name: order.code || "زبون",
        client_mobile: normalizePhone(order.phone1 || ""),
        client_mobile2: order.phone2 ? normalizePhone(order.phone2) : "",
        city_id: cityId,
        region_id: regionId,
        location: order.address || "",
        type_name: order.productName || "منتج غير محدد",
        items_number: order.quantity?.toString() || "1",
        price: order.price?.toString() || "0",
        package_size: "1",
        merchant_notes: order.notes || "",
        replacement: 0,
      };

      // إرسال الطلب
      console.log("📦 إرسال الطلب:", payload);

    const formData = new FormData();
for (const key in payload) formData.append(key, payload[key]);

const response = await fetch(`https://api.alwaseet-iq.net/v1/merchant/create-order?token=${token}`, {
  method: "POST",
  body: formData,
});



      const data = await response.json();
      console.log("📬 استجابة الوسيط:", data);

      if (data.status === true && data.data?.qr_id) {
  const qrId = data.data.qr_id;
  const qrLink = data.data.qr_link;

        // ✅ تحديث الطلب في Firebase
        await update(ref(db, "orders/" + order.id), {
          status: "قيد التجهيز",
          receiptNum: qrId.toString(),
          waseet_link: qrLink,
        });

        // إزالة الطلب من الجدول
        const row = document.querySelector(`input[data-id='${order.id}']`)?.closest("tr");
        if (row) row.remove();

        sentCount++;
      } else {
        console.warn("❌ فشل رفع الطلب:", data.msg || data);
        failedCount++;

        // تلوين الصف بالأحمر
        const row = document.querySelector(`input[data-id='${order.id}']`)?.closest("tr");
        if (row) row.style.backgroundColor = "#ffcccc";
      }
    }

    alert(`✅ تم رفع ${sentCount} طلب بنجاح، ❌ فشل ${failedCount} طلب.`);
  } catch (err) {
    console.error("❌ خطأ أثناء رفع الطلبات:", err);
    alert("❌ حدث خطأ أثناء رفع الطلبات، تحقق من الاتصال بالسيرفر.");
  }
});


// 🔢 دالة تنسيق رقم الهاتف
function normalizePhone(phone) {
  const arabicToEnglish = {
    '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
    '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9'
  };
  let cleaned = phone.replace(/[^\d٠-٩]/g, '');
  cleaned = cleaned.split('').map(c => arabicToEnglish[c] || c).join('');
  if (cleaned.startsWith("0")) return "+964" + cleaned.slice(1);
  if (cleaned.startsWith("7")) return "+964" + cleaned;
  if (!cleaned.startsWith("+964")) return "+964" + cleaned;
  return cleaned;
}


  </script>

</body>
</html> 