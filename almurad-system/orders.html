<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</title>
  <style>
    body {
      font-family: Tahoma, Arial;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }
    header {
      background: #043B64;
      color: white;
      text-align: center;
      padding: 12px;
      font-size: 18px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
    }
    .back-btn {
      background: #043B64;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 13px;
    }
    .delete-btn {
      background: #d93025;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 13px;
    }
    .search-bar {
      text-align: center;
      margin: 10px 0 15px;
    }
    .search-bar input {
      width: 60%;
      padding: 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .table-container {
      width: 100%;
      overflow-x: auto;
      white-space: nowrap;
      padding: 10px;
    }
    table {
      width: max-content;
      min-width: 1400px;
      margin: 0 auto;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 6px 8px;
      text-align: center;
      border-bottom: 1px solid #ddd;
      font-size: 12px;
    }
    th { background: #043B64; color: white; }
    tr:hover { background: #f9fafb; }
    input, select, textarea {
      font-size: 12px;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
    }
    textarea { resize: vertical; height: 40px; }
    button {
      background: #FF6B2D;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }
    /* ğŸ”¸ Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
input, select, textarea {
  font-size: 16px !important;
}

    button:hover { opacity: 0.9; }
    /* ğŸ”½ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ø£ÙˆØ§Ù…Ø± */
.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #ffffff;
  min-width: 200px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  border-radius: 6px;
  z-index: 9999;
  right: 0;
  top: 40px;
}

.dropdown-content button {
  background: none;
  color: #333;
  border: none;
  padding: 10px 15px;
  text-align: right;
  width: 100%;
  font-size: 13px;
  cursor: pointer;
}

.dropdown-content button:hover {
  background-color: #f1f1f1;
}

/* ğŸ”¸ Ø¸Ù‡ÙˆØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
.show {
  display: block;
}

  </style>
</head>
<body>

  <header id="pageTitle">ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</header>

  <div class="top-bar">
  <button class="back-btn" id="backBtn">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
  <div class="dropdown">
    <button class="back-btn" id="commandsBtn">âš™ï¸ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ÙˆØ³ÙŠØ· â–¾</button>
    <div class="dropdown-content" id="commandsMenu">
      <button id="sendToWaseet">ğŸš€ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ©</button>
      <button id="updateStatuses">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª</button>
    </div>
  </div>
  <button class="delete-btn" id="deleteSelected">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</button>
</div>


  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø©...">
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Ø§Ø®ØªÙŠØ§Ø±</th>
          <th>#</th>
          <th>ØªÙØ§ØµÙŠÙ„</th>
          <th>Ø§Ù„ÙƒÙˆØ¯</th>
          <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ</th>
          <th>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th>
          <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
          <th>ÙˆØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
          <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
          <th>Ø§Ù„Ù…Ø¹Ù„Ù†</th>
        </tr>
      </thead>
      <tbody id="ordersBody">
        <tr><td colspan="17">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</td></tr>
      </tbody>
    </table>
  </div>
<script type="module">
  import { waseetCities } from "./waseetCities.js";
  import { waseetRegions } from "./waseetRegions.js";
  import { citiesData, allCities } from "./citiesData.js";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getDatabase, ref, onValue, update, remove, get } 
    from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
      authDomain: "almurad-system.firebaseapp.com",
      databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
      projectId: "almurad-system",
      storageBucket: "almurad-system.appspot.com",
      messagingSenderId: "911755824405",
      appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
    };

   const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ordersBody = document.getElementById("ordersBody");
const searchInput = document.getElementById("searchInput");

// ğŸ”¹ Ù†Ø¶ÙŠÙ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§
const currentUser = sessionStorage.getItem("userName") || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";


    let allProducts = [];
    let allOrders = [];
    const urlParams = new URLSearchParams(window.location.search);
    const currentStatus = decodeURIComponent(urlParams.get("status") || "");

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    const productsRef = ref(db, "products");
    onValue(productsRef, (snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        allProducts = Object.values(data).map(p => p.name || p);
      }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ ÙÙ„ØªØ±Ø© Ø¯Ù‚ÙŠÙ‚Ø©
    const ordersRef = ref(db, "orders");
    onValue(ordersRef, (snapshot) => {
      if (!snapshot.exists()) {
        ordersBody.innerHTML = `<tr><td colspan="17">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>`;
        return;
      }

      allOrders = Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data }));
      
      // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const filtered = allOrders.filter(o => {
        const st = (o.status || "").trim();
        return currentStatus === "" 
          ? (st === "" || st === null)
          : st === currentStatus;
      });

      renderOrders(filtered);
    });

    // Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„Ù…Ù†Ø³Ø¯Ù„Ø§Øª
    function createEditableInput(value, onSave) {
      const input = document.createElement("input");
      input.value = value || "";
      input.addEventListener("change", e => onSave(e.target.value));
      return input;
    }

    function createTextarea(value, onSave) {
      const t = document.createElement("textarea");
      t.value = value || "";
      t.addEventListener("change", e => onSave(e.target.value));
      return t;
    }

    function createDropdown(options, selected, onChange) {
      const wrapper = document.createElement("div");
      const input = document.createElement("input");
      input.type = "text";
      input.value = selected || "";
      input.placeholder = "Ø§Ø®ØªØ±...";
      input.style.cursor = "pointer";

      const dropdown = document.createElement("div");
      Object.assign(dropdown.style, {
        position: "fixed",
        background: "#fff",
        border: "1px solid #ccc",
        borderRadius: "6px",
        boxShadow: "0 3px 10px rgba(0,0,0,0.2)",
        maxHeight: "200px",
        overflowY: "auto",
        zIndex: "999999",
        display: "none",
        fontSize: "12px"
      });

      function renderList(filter = "") {
        dropdown.innerHTML = "";
        options.filter(o => o.includes(filter)).forEach(o => {
          const opt = document.createElement("div");
          opt.textContent = o;
          opt.style.padding = "5px 8px";
          opt.style.cursor = "pointer";
          opt.addEventListener("click", () => {
            input.value = o;
            dropdown.style.display = "none";
            onChange(o);
          });
          dropdown.appendChild(opt);
        });
      }

      input.addEventListener("focus", () => {
        const rect = input.getBoundingClientRect();
        dropdown.style.top = rect.bottom + "px";
        dropdown.style.left = rect.left + "px";
        dropdown.style.width = rect.width + "px";
        dropdown.style.display = "block";
        renderList();
      });

      input.addEventListener("input", e => renderList(e.target.value.trim()));
      document.addEventListener("click", e => {
        if (!wrapper.contains(e.target)) dropdown.style.display = "none";
      });

      wrapper.appendChild(input);
      document.body.appendChild(dropdown);
      return wrapper;
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    function renderOrders(orders) {
      ordersBody.innerHTML = "";
      if (orders.length === 0) {
        ordersBody.innerHTML = `<tr><td colspan="17">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©</td></tr>`;
        return;
      }

      orders.forEach((order, index) => {
        const tr = document.createElement("tr");
        const areas = citiesData[order.city] || [];

        // âœ… Ø§Ø®ØªÙŠØ§Ø±
        const selectTd = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.dataset.id = order.id;
        selectTd.appendChild(checkbox);
        tr.appendChild(selectTd);

        // ğŸ”¢ ØªØ³Ù„Ø³Ù„
        const indexTd = document.createElement("td");
        indexTd.textContent = index + 1;
        tr.appendChild(indexTd);

        // ğŸ” ØªÙØ§ØµÙŠÙ„
        const detailsTd = document.createElement("td");
        const detailsBtn = document.createElement("button");
        detailsBtn.textContent = "ğŸ” ØªÙØ§ØµÙŠÙ„";
        detailsBtn.style.background = "#FF6B2D";
detailsBtn.addEventListener("click", () => {
  const modal = document.getElementById("detailsModal");
  const frame = document.getElementById("detailsFrame");
  localStorage.setItem("selectedOrder", order.id);
  frame.src = "order-details.html"; // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
  modal.style.display = "block";

  // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥ØºÙ„Ø§Ù‚Ù‡Ø§ Ø¨Ø²Ø± Ø±Ø¬ÙˆØ¹
  window.addEventListener("message", (e) => {
    if (e.data === "closeDetailsModal") {
      modal.style.display = "none";
      frame.src = "";
    }
  });
});

        detailsTd.appendChild(detailsBtn);
        tr.appendChild(detailsTd);

        // Ø¨Ù‚ÙŠØ© Ø§Ù„Ø­Ù‚ÙˆÙ„
        const fields = [
          { val: order.code, fn: v => update(ref(db, `orders/${order.id}`), { code: v }) },
          { val: order.phone1 || order.phone, fn: v => update(ref(db, `orders/${order.id}`), { phone1: v }) },
          { val: order.phone2, fn: v => update(ref(db, `orders/${order.id}`), { phone2: v }) },
          { city: true },
          { area: true },
          { val: order.address, textarea: true, fn: v => update(ref(db, `orders/${order.id}`), { address: v }) },
          { val: order.price, fn: v => update(ref(db, `orders/${order.id}`), { price: v }) },
          { val: order.quantity, fn: v => update(ref(db, `orders/${order.id}`), { quantity: v }) },
          { val: order.productName || order.product, dropdown: allProducts, fn: v => update(ref(db, `orders/${order.id}`), { productName: v }) },
          { val: order.notes, textarea: true, fn: v => update(ref(db, `orders/${order.id}`), { notes: v }) },
          { val: order.receiptNum, fn: v => update(ref(db, `orders/${order.id}`), { receiptNum: v }) },
          {
           
  val: order.status || "",
  dropdown: ["", "Ù…Ø«Ø¨Øª", "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©", "Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²", "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©", "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„", "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…", "Ø±Ø§Ø¬Ø¹", "Ø±ÙØ¶"],
  fn: async (newStatus) => {
const userName = currentUser;
    const orderRef = ref(db, `orders/${order.id}`);

    // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const snap = await get(orderRef);
    const existing = snap.exists() ? snap.val() : {};

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
    await update(orderRef, {
      status: newStatus,
      updatedBy: userName,
      updatedAt: new Date().toISOString(),
fixedBy:
  (existing.fixedBy && existing.fixedBy !== "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ")
    ? existing.fixedBy
    : ((newStatus === "Ù…Ø«Ø¨Øª" || newStatus === "Ø±ÙØ¶") ? userName : existing.fixedBy || userName)
    });

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const st = (newStatus || "").trim();
    const shouldHide =
      (currentStatus === "" && st !== "") ||
      (currentStatus !== "" && st !== currentStatus);
    if (shouldHide) tr.remove();
  }
}
,
          { val: order.orderDate || "-", readonly: true },
          { val: order.advertiser, fn: v => update(ref(db, `orders/${order.id}`), { advertiser: v }) }
        ];

        fields.forEach(f => {
          const td = document.createElement("td");
          if (f.readonly) td.textContent = f.val || "-";
          else if (f.textarea) td.appendChild(createTextarea(f.val, f.fn));
          else if (f.dropdown) td.appendChild(createDropdown(f.dropdown, f.val, f.fn));
          else if (f.city) {
            const cityDropdown = createDropdown(allCities, order.city || "", val => update(ref(db, `orders/${order.id}`), { city: val, area: "" }));
            td.appendChild(cityDropdown);
          } else if (f.area) {
            const areaDropdown = createDropdown(areas, order.area || "", val => update(ref(db, `orders/${order.id}`), { area: val }));
            td.appendChild(areaDropdown);
          } else td.appendChild(createEditableInput(f.val, f.fn));
          tr.appendChild(td);
        });

        ordersBody.appendChild(tr);
      });
    }

    // ğŸ” Ø§Ù„Ø¨Ø­Ø«
    searchInput.addEventListener("input", e => {
      const q = e.target.value.trim();
      const filtered = allOrders.filter(o => Object.values(o).some(v => v && v.toString().includes(q)));
      renderOrders(filtered);
    });

    // ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    document.getElementById("deleteSelected").addEventListener("click", () => {
      const checked = Array.from(document.querySelectorAll("input[type='checkbox']:checked"));
      if (checked.length === 0) return alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª!");
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŸ")) return;
      checked.forEach(ch => remove(ref(db, `orders/${ch.dataset.id}`)));
      alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");
    });

    document.getElementById("backBtn").addEventListener("click", () => window.location.href = "dashboard.html");



// ğŸšš Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ· (Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ù‘Ø«Ø©)
// ğŸšš Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ· (Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ø±Ø© ÙˆÙ…Ø¬Ø±Ø¨Ø©)
// ğŸš€ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© ÙˆØ§Ø­Ø¯Ø© ØªÙ„Ùˆ Ø§Ù„Ø£Ø®Ø±Ù‰ (Ù†Ø³Ø®Ø© Ø£ØµÙ„ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø©)
document.getElementById("sendToWaseet").addEventListener("click", async () => {
  // ğŸŸ© Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰
  let statusBar = document.getElementById("statusBar");
  if (!statusBar) {
    statusBar = document.createElement("div");
    statusBar.id = "statusBar";
    Object.assign(statusBar.style, {
      position: "fixed",
      top: "0",
      right: "0",
      left: "0",
      padding: "12px",
      textAlign: "center",
      backgroundColor: "#043B64",
      color: "white",
      fontSize: "15px",
      fontWeight: "bold",
      zIndex: "999999",
      transition: "0.4s ease"
    });
    document.body.appendChild(statusBar);
  }
  const showMsg = (text, color = "#043B64") => {
    statusBar.textContent = text;
    statusBar.style.backgroundColor = color;
    statusBar.style.display = "block";
  };

  try {
    showMsg("â³ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·...");

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†
    const loginResponse = await fetch("https://almurad.onrender.com/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: "ramadan@almurad",
        password: "ramadan1998@"
      })
    });

    const loginData = await loginResponse.json();
    const token = loginData.data?.token;
    if (!token) {
      showMsg("âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·", "#b30000");
      return;
    }

    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© ÙÙ‚Ø·
    const confirmedOrders = allOrders.filter(o => (o.status || "").trim() === "Ù…Ø«Ø¨Øª");
    if (confirmedOrders.length === 0) {
      showMsg("âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø«Ø¨ØªØ© Ø­Ø§Ù„ÙŠØ§Ù‹.", "#28a745");
      setTimeout(() => (statusBar.style.display = "none"), 2500);
      return;
    }

    let sentCount = 0, failedCount = 0;
    showMsg(`ğŸš€ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${confirmedOrders.length} Ø·Ù„Ø¨...`);

    // Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ø­Ø¯Ø§Ù‹ ØªÙ„Ùˆ Ø§Ù„Ø¢Ø®Ø±
    for (const order of confirmedOrders) {
      try {
        const cityMatch = waseetCities.find(c => c.city_name === order.city);
        const regionMatch = waseetRegions.find(r => r.region_name === order.area);
        const cityId = cityMatch ? cityMatch.id : "";
        const regionId = regionMatch ? regionMatch.id : "";

        if (!cityId || !regionId) {
          failedCount++;
          continue;
        }

        const payload = {
          token,
          client_name: order.code || "Ø²Ø¨ÙˆÙ†",
          client_mobile: normalizePhone(order.phone1 || ""),
          client_mobile2: order.phone2 ? normalizePhone(order.phone2) : "",
          city_id: cityId,
          region_id: regionId,
          location: order.address || "",
          type_name: order.productName || "Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
          items_number: order.quantity?.toString() || "1",
          price: order.price?.toString() || "0",
          package_size: "1",
          merchant_notes: order.notes || "",
          replacement: 0,
        };

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„ÙˆØ³ÙŠØ· (Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø³ÙŠØ±ÙØ±Ùƒ Ø§Ù„Ø®Ø§Øµ)
        const response = await fetch("https://almurad.onrender.com/api/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await response.json();
        console.log("ğŸ“¬ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ÙˆØ³ÙŠØ·:", data);

        if (data.status === true && data.data?.qr_id) {
          await update(ref(db, `orders/${order.id}`), {
            status: "Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²",
            receiptNum: data.data.qr_id.toString(),
            waseet_link: data.data.qr_link,
          });
          sentCount++;
        } else {
          failedCount++;
        }
      } catch (err) {
        failedCount++;
        console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨:", err);
      }
    }

    showMsg(`âœ… ØªÙ… Ø±ÙØ¹ ${sentCount} Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ØŒ âŒ ÙØ´Ù„ ${failedCount}.`, "#28a745");
    setTimeout(() => (statusBar.style.display = "none"), 4000);
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:", err);
    showMsg("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.", "#b30000");
  }
});



// ğŸ”¢ Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
function normalizePhone(phone) {
  const arabicToEnglish = {
    'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4',
    'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9'
  };
  let cleaned = phone.replace(/[^\dÙ -Ù©]/g, '');
  cleaned = cleaned.split('').map(c => arabicToEnglish[c] || c).join('');
  if (cleaned.startsWith("0")) return "+964" + cleaned.slice(1);
  if (cleaned.startsWith("7")) return "+964" + cleaned;
  if (!cleaned.startsWith("+964")) return "+964" + cleaned;
  return cleaned;
}
// ğŸ”½ Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ÙˆØ³ÙŠØ·
const commandsBtn = document.getElementById("commandsBtn");
const commandsMenu = document.getElementById("commandsMenu");

commandsBtn.addEventListener("click", () => {
  commandsMenu.classList.toggle("show");
});

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
window.addEventListener("click", (e) => {
  if (!commandsBtn.contains(e.target)) commandsMenu.classList.remove("show");
});

// ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ³ÙŠØ·
// ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ³ÙŠØ· (Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù‘Ù†Ø©)
// ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ³ÙŠØ· (Bulk - ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©)
document.getElementById("updateStatuses").addEventListener("click", async () => {
  // ğŸŸ© Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  let statusBar = document.getElementById("statusBar");
  if (!statusBar) {
    statusBar = document.createElement("div");
    statusBar.id = "statusBar";
    Object.assign(statusBar.style, {
      position: "fixed",
      top: "0",
      right: "0",
      left: "0",
      padding: "12px",
      textAlign: "center",
      backgroundColor: "#043B64",
      color: "white",
      fontSize: "15px", 
      fontWeight: "bold",
      zIndex: "999999",
      transition: "0.4s ease"
    });
    document.body.appendChild(statusBar);
  }
  function showMsg(text, color = "#043B64") {
    statusBar.textContent = text;
    statusBar.style.backgroundColor = color;
    statusBar.style.display = "block";
  }

  try {
    showMsg("â³ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·...");

    // ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†
    const loginResponse = await fetch("https://almurad.onrender.com/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: "ramadan@almurad",
        password: "ramadan1998@"
      })
    });

    const loginData = await loginResponse.json();
    const token = loginData.data?.token;
    if (!token) {
      showMsg("âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·", "#b30000");
      return;
    }

    // ğŸŸ  Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙ‚Ø·
    const allowedToCheck = ["Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²", "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„", "Ø±Ø§Ø¬Ø¹"];

    // ğŸ§© Ø§Ù„Ù…Ø§Ø¨ÙŠÙ†Ú¯ Ø¨ÙŠÙ† Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙˆØ³ÙŠØ· ÙˆØ­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    const statusMapping = {
      "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù„Ø²Ø¨ÙˆÙ†": "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
      "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨": "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„",
      "Ø§Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±": "Ø±Ø§Ø¬Ø¹",
      "ØªÙ… Ø§Ù„Ø§Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±": "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹",
      "ÙÙŠ Ù…ÙˆÙ‚Ø¹ ÙØ±Ø² Ø¨ØºØ¯Ø§Ø¯": "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„"
    };

    // ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ« ÙÙ‚Ø·
    const ordersToUpdate = allOrders.filter(
      o => allowedToCheck.includes((o.status || "").trim()) && o.receiptNum
    );

    if (ordersToUpdate.length === 0) {
      showMsg("âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ«.", "#28a745");
      setTimeout(() => (statusBar.style.display = "none"), 2500);
      return;
    }

    showMsg(`ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« ${ordersToUpdate.length} Ø·Ù„Ø¨ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©...`);

    // ğŸ§¾ ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
    const allIds = ordersToUpdate.map(o => o.receiptNum).join(",");

    // ğŸ“¡ Ø¥Ø±Ø³Ø§Ù„ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø³ÙŠØ±ÙØ±
    const response = await fetch("https://almurad.onrender.com/api/get-orders-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token, ids: allIds })
    });

    const data = await response.json();

    if (!data.status || !data.data) {
      showMsg("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ³ÙŠØ·.", "#b30000");
      return;
    }

    let updatedCount = 0;

    // ğŸ” ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙƒÙ„Ù‡Ø§ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø§Ù„Ù€ Firebase
    for (const orderData of data.data) {
      const apiStatus = (orderData.status || "").trim();
      const mappedStatus = statusMapping[apiStatus] || null;
      if (!mappedStatus) continue;

      const targetOrder = allOrders.find(
        o => (o.receiptNum || "").toString() === orderData.id.toString()
      );
      if (targetOrder) {
        await update(ref(db, `orders/${targetOrder.id}`), {
          status: mappedStatus
        });
        updatedCount++;

        if (apiStatus === "ÙÙŠ Ù…ÙˆÙ‚Ø¹ ÙØ±Ø² Ø¨ØºØ¯Ø§Ø¯") {
          await update(ref(db, `orders/${targetOrder.id}`), {
            notes:
              (targetOrder.notes || "") +
              (targetOrder.notes ? " | " : "") +
              "ØªØ­ÙˆÙ„Øª Ù…Ù† Ù…ÙˆÙ‚Ø¹ ÙØ±Ø²"
          });
        }
      }
    }

    showMsg(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedCount} Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.`, "#28a745");
    setTimeout(() => (statusBar.style.display = "none"), 3000);
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª:", err);
    showMsg("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª.", "#b30000");
  }
});
// âœ… Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©
function openOrderDetailsInline(order) {
  const overlay = document.createElement("div");
  Object.assign(overlay.style, {
    position: "fixed",
    top: "0", left: "0", right: "0", bottom: "0",
    background: "rgba(0,0,0,0.4)",
    display: "flex",
    justifyContent: "center",
    alignItems: "center",
    zIndex: "999999"
  });

  const box = document.createElement("div");
  Object.assign(box.style, {
    background: "white",
    borderRadius: "10px",
    padding: "20px",
    width: "90%",
    maxWidth: "600px",
    maxHeight: "90%",
    overflowY: "auto",
    direction: "rtl",
    textAlign: "right"
  });

  box.innerHTML = `
    <h3 style="text-align:center;color:#043B64;margin-top:0;">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
    <p><b>Ø§Ù„ÙƒÙˆØ¯:</b> ${order.code || "-"}</p>
    <p><b>Ø§Ù„Ù…Ù†ØªØ¬:</b> ${order.productName || "-"}</p>
    <p><b>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</b> ${order.city || "-"}</p>
    <p><b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${order.area || "-"}</p>
    <p><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${order.address || "-"}</p>
    <p><b>Ø§Ù„Ø³Ø¹Ø±:</b> ${order.price || "-"}</p>
    <p><b>Ø§Ù„ÙƒÙ…ÙŠØ©:</b> ${order.quantity || "-"}</p>
    <p><b>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${order.notes || "-"}</p>
    <p><b>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</b> ${order.phone1 || "-"}</p>
    <p><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${order.status || "-"}</p>
    <p><b>Ø§Ù„Ù…Ø¹Ù„Ù†:</b> ${order.advertiser || "-"}</p>
    <div style="text-align:center;margin-top:20px;">
      <button id="closeOrderModal" style="background:#043B64;color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  `;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  document.getElementById("closeOrderModal").addEventListener("click", () => overlay.remove());
}



  </script>
  <!-- âœ… Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ù…Ù†Ø³ÙˆØ®Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„) -->
  <div id="detailsModal" style="display:none;">
    <iframe id="detailsFrame" style="
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      border:none;
      z-index:999999;
    "></iframe>
  </div>

</body>
</html>
