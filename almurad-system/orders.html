<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</title>
  <style>

    body {
      font-family: Tahoma, Arial;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }
    header {
      background: #043B64;
      color: white;
      text-align: center;
      padding: 12px;
      font-size: 18px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
    }
    .back-btn {
      background: #043B64;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 13px;
    }
    .delete-btn {
      background: #d93025;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 13px;
    }
    .search-bar {
      text-align: center;
      margin: 10px 0 15px;
    }
    .search-bar input {
      width: 60%;
      padding: 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
   .table-container {
  width: 100%;
  overflow-x: auto;
  overflow-y: auto; /* âœ… ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ */
  white-space: nowrap;
  padding: 10px;
  max-height: 80vh; /* âœ… ÙŠØ®Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¶Ù…Ù† Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© */
}
thead th {
  position: sticky;
  top: 0;
  background: #043B64;
  color: white;
  z-index: 10;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}


    table {
      width: max-content;
      min-width: 1400px;
      margin: 0 auto;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 6px 8px;
      text-align: center;
      border-bottom: 1px solid #ddd;
      font-size: 12px;
    }
    th { background: #043B64; color: white; }
    tr:hover { background: #f9fafb; }
    input, select, textarea {
      font-size: 12px;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
    }
    textarea { resize: vertical; height: 40px; }
    button {
      background: #FF6B2D;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }
    /* ğŸ”¸ Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
input, select, textarea {
  font-size: 16px !important;
}

    button:hover { opacity: 0.9; }
    /* ğŸ”½ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ø£ÙˆØ§Ù…Ø± */
.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #ffffff;
  min-width: 200px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  border-radius: 6px;
  z-index: 9999;
  right: 0;
  top: 40px;
}

.dropdown-content button {
  background: none;
  color: #333;
  border: none;
  padding: 10px 15px;
  text-align: right;
  width: 100%;
  font-size: 13px;
  cursor: pointer;
}

.dropdown-content button:hover {
  background-color: #f1f1f1;
}

/* ğŸ”¸ Ø¸Ù‡ÙˆØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
.show {
  display: block;
}
/* ğŸ”” Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù„ÙˆÙŠ Ø£Ù†ÙŠÙ‚ */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #FF6B2D;
  color: #fff;
  padding: 14px 22px;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.25);
  font-family: 'Tajawal', sans-serif;
  font-size: 16px;
  z-index: 9999;
  opacity: 0;
  transform: translateY(-20px);
  transition: opacity 0.3s ease, transform 0.3s ease;
}
.notification.show {
  opacity: 1;
  transform: translateY(0);
}
@media (max-width: 768px) {
  input, select, textarea, button {
    font-size: 16px !important;
    touch-action: manipulation;
  }
}

  </style>
</head>
<body>

  <header id="pageTitle">ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</header>
<h2 id="pageStatusTitle" style="
  text-align:center;
  background:#FF6B2D;
  color:white;
  font-weight:bold;
  padding:10px 0;
  margin:10px 0;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
"></h2>

  <div class="top-bar">
  <button class="back-btn" id="backBtn">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
  <div class="dropdown">
    <button class="back-btn" id="commandsBtn">âš™ï¸ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ÙˆØ³ÙŠØ· â–¾</button>
    <div class="dropdown-content" id="commandsMenu">
      <button id="sendToWaseet">ğŸš€ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ©</button>
      <button id="updateStatuses">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª</button>
    </div>
  </div>
  <button class="delete-btn" id="deleteSelected">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</button>
</div>


  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø©...">
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Ø§Ø®ØªÙŠØ§Ø±</th>
          <th>#</th>
          <th>ØªÙØ§ØµÙŠÙ„</th>
          <th>Ø§Ù„ÙƒÙˆØ¯</th>
          <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ</th>
          <th>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th>
          <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
          <th>ÙˆØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
          <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
          <th>Ø§Ù„Ù…Ø¹Ù„Ù†</th>
        </tr>
      </thead>
      <tbody id="ordersBody">
        <tr><td colspan="17">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</td></tr>
      </tbody>
    </table>
  </div>
<script type="module">
  // ğŸ§  Ø­ÙØ¸ Ø¢Ø®Ø± Ø­Ø§Ù„Ø© ÙŠÙØªØ­Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±
window.addEventListener("beforeunload", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const currentStatus = decodeURIComponent(urlParams.get("status") || "");
  localStorage.setItem("lastStatusView", currentStatus);
  localStorage.setItem("previousScrollPosition", window.scrollY);
});

  import { waseetCities } from "./waseetCities.js";
  import { waseetRegions } from "./waseetRegions.js";
  import { citiesData, allCities } from "./citiesData.js";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getDatabase, ref, onValue, update, remove, get } 
    from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
    // ğŸ§© Ø¯Ø§Ù„Ø© Ù„Ø±Ø¨Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
// ğŸ§© Ø¯Ø§Ù„Ø© Ø°ÙƒÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
// âœ… ØªØ­Ø¯ÙŠØ« Ø°ÙƒÙŠ Ù„Ù„Ù…Ø®Ø²ÙˆÙ† Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ (ÙŠØ¯Ø¹Ù… ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…ØªØºÙŠØ±Ø§Øª)
// âœ… Ø¯Ø§Ù„Ø© ØªØ¶Ù…Ù† Ø­ÙØ¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙƒØ§Ù…Ù„Ø© Ù‚Ø¨Ù„ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø©
async function ensureOrderDetailsSaved(orderId) {
  const db = getDatabase();
  const orderRef = ref(db, `orders/${orderId}`);
  const snap = await get(orderRef);
  if (!snap.exists()) return;
  const order = snap.val();

  // Ù„Ùˆ Ø£ØµÙ„Ø§Ù‹ Ù…ÙˆØ¬ÙˆØ¯ productsDetailedØŒ Ù…Ø§ Ù†Ø³ÙˆÙŠ Ø´ÙŠ
// Ù„Ùˆ Ù…Ø§ÙƒÙˆ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ¹Ù„ÙŠØ© Ø¯Ø§Ø®Ù„ productsDetailed Ù†Ø¹ÙŠØ¯ ØªÙˆÙ„ÙŠØ¯Ù‡Ø§
if (
  !order.productsDetailed ||
  !Array.isArray(order.productsDetailed) ||
  order.productsDetailed.length === 0 ||
  !order.productsDetailed[0]?.name
) {
  // Ù†ÙƒÙ…Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø£Ø¯Ù†Ø§Ù‡
} else {
  return; // Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙØ¹Ù„ÙŠØ©ØŒ Ù†Ø·Ù„Ø¹
}

  // Ù†Ø¬Ù‡Ø² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
  const productName = order.productName || "";
  const qty = Number(order.quantity) || 0;
  const variants = order.selectedVariants || {};

  if (!productName || qty <= 0) return;

  const details = [{
    name: productName,
    qty: qty,
    variants: variants
  }];

  await update(orderRef, { productsDetailed: details });
  console.log(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ${orderId} ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹`);
}

window.adjustStockOnStatusChange = async function (orderId, newStatus) {
  const db = getDatabase();
  const orderRef = ref(db, `orders/${orderId}`);
  const orderSnap = await get(orderRef);
  if (!orderSnap.exists()) return;
  const order = orderSnap.val();

  console.log("ğŸ”¥ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:", orderId, newStatus);

  // ğŸ§© ØªØ¬Ù…ÙŠØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ + Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ)
  const products = [];

  function addProduct(name, qty, variants) {
    if (!name || isNaN(qty)) return;
    const cleanName = name.trim();
    const hasVariants = variants && Object.keys(variants).length > 0;
    const variantKey = hasVariants
      ? Object.entries(variants)
          .map(([k, v]) => `${k} | ${v}`)
          .join(" | ")
      : "Ø¨Ø¯ÙˆÙ† Ù…ØªØºÙŠØ±";
    products.push({ name: cleanName, qty, variantKey, variants });
  }

  // ğŸŸ¢ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
  if (order.productName && order.quantity) {
    addProduct(order.productName, parseInt(order.quantity), order.selectedVariants || {});
  }

  // ğŸŸ¢ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (extraProducts)
  if (Array.isArray(order.extraProducts)) {
    order.extraProducts.forEach((p) => {
      addProduct(p.name, parseInt(p.qty) || 1, p.selectedVariants || {});
    });
  }

  // ğŸŸ¢ productsDetailed (ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø³Ø¨Ù‚)
  if (Array.isArray(order.productsDetailed)) {
    order.productsDetailed.forEach((p) => {
      addProduct(p.name, parseInt(p.qty) || 1, p.variants || {});
    });
  }

  // ğŸ§± Ù†Ø¨Ø¯Ø£ ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ù…Ø®Ø²Ù†
  for (const item of products) {
    const { name, qty, variantKey, variants } = item;
    const warehouseRef = ref(db, `warehouse/${name}`);
    const warehouseSnap = await get(warehouseRef);
    if (!warehouseSnap.exists()) {
      console.warn(`ğŸš« Ø§Ù„Ù…Ù†ØªØ¬ "${name}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†`);
      continue;
    }

    const warehouse = warehouseSnap.val();
    const stock = warehouse.stock || {};
    const processed = warehouse.processedOrders || {};
    let totalQty = parseInt(warehouse.totalQty || 0);

   // ğŸ§  Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ØµØ­ÙŠØ­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
let foundKey = null;

// Ù†ÙƒÙˆÙ‘Ù† Ù…ØµÙÙˆÙØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (Ù…Ø«Ù„ Ø§Ù„Ù„ÙˆÙ†ØŒ Ø§Ù„Ø­Ø¬Ù…ØŒ Ø§Ù„Ø´ÙƒÙ„ØŒ Ø§Ù„Ù‚ÙŠØ§Ø³)
const variantValues = Object.values(variants || {}).map(v => v.trim().toLowerCase());

// Ù†Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ù…ÙØªØ§Ø­ Ù…Ù† Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù€ stock
for (const key of Object.keys(stock)) {
  const normalizedKey = key.trim().toLowerCase();

  // Ù†Ø­Ø³Ø¨ ÙƒÙ… Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙØªØ§Ø­
  const matches = variantValues.filter(v => normalizedKey.includes(v)).length;

  // Ø¥Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª â†’ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
  if (matches === variantValues.length && matches > 0) {
    foundKey = key;
    break;
  }
}


    // ğŸ§© ØªÙˆÙ„ÙŠØ¯ Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„Ù„Ø·Ù„Ø¨ Ø­ØªÙ‰ Ù„Ø§ ÙŠØªÙƒØ±Ø± Ø§Ù„Ø®ØµÙ… Ø£Ùˆ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
    const variantId = variantKey.replace(/\s+/g, "_");
    const uniqueKey = `${orderId}_${name}_${variantId}`;

// âœ… Ø§Ù„Ø®ØµÙ… Ø¹Ù†Ø¯ Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„
if (newStatus === "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„" && !processed[`deduct_${uniqueKey}`]) {
  if (foundKey && stock[foundKey] !== undefined) {
    // ğŸ§© Ø¥Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨ÙŠ Ù…ØªØºÙŠØ±Ø§Øª ÙˆÙ…ÙØªØ§Ø­ Ù…Ø·Ø§Ø¨Ù‚
    stock[foundKey] = Math.max(0, stock[foundKey] - qty);
    console.log(`ğŸ“¦ Ø®ØµÙ… ${qty} Ù…Ù† ${name} (${foundKey})`);
    processed[`deduct_${uniqueKey}`] = true;
  } 
  else if (!foundKey && (!variants || Object.keys(variants).length === 0)) {
    // ğŸŸ¢ Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ù…ØªØºÙŠØ±Ø§Øª â†’ ÙŠØ®ØµÙ… Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©
    if (stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] !== undefined) {
      stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] = Math.max(0, stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] - qty);
      console.log(`ğŸ“¦ Ø®ØµÙ… ${qty} Ù…Ù† ${name} (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©)`);
      processed[`deduct_${uniqueKey}`] = true;
    } else {
      showNotification(`ğŸš« Ø§Ù„Ù…Ù†ØªØ¬ "${name}" Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØªØºÙŠØ±Ø§Øª Ø£Ùˆ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ…ÙŠØ§Øª.`, "#FF6B2D");
      continue;
    }
  } 
  else {
    // ğŸš« Ù„Ø§ Ù…ØªØºÙŠØ± ÙˆÙ„Ø§ ØªØ·Ø§Ø¨Ù‚
    showNotification(`ğŸš« Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ± "${name}" Ø£Ùˆ Ø£Ù†Ù‡ Ù†ÙØ¯ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†!`, "#FF6B2D");
    continue;
  }
}

// âœ… Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø¹Ù†Ø¯ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹
if (newStatus === "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹" && !processed[`return_${uniqueKey}`]) {
  if (foundKey && stock[foundKey] !== undefined) {
    stock[foundKey] += qty;
    console.log(`ğŸ” Ø¥Ø±Ø¬Ø§Ø¹ ${qty} Ø¥Ù„Ù‰ ${name} (${foundKey})`);
    processed[`return_${uniqueKey}`] = true;
  } 
  else if (!foundKey && (!variants || Object.keys(variants).length === 0)) {
    if (stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] !== undefined) {
      stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] += qty;
      console.log(`ğŸ” Ø¥Ø±Ø¬Ø§Ø¹ ${qty} Ø¥Ù„Ù‰ ${name} (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©)`);
      processed[`return_${uniqueKey}`] = true;
    } else {
      showNotification(`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø¬Ø§Ø¹ "${name}" Ù„Ø£Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØªØºÙŠØ±Ø§Øª.`, "#043B64");
      continue;
    }
  } 
  else {
    showNotification(`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø¬Ø§Ø¹ "${name}" Ù„Ø£Ù† Ø§Ù„Ù…ØªØºÙŠØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.`, "#043B64");
    continue;
  }
}



    // âœ… Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø¹Ù†Ø¯ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹
    if (newStatus === "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹" && !processed[`return_${uniqueKey}`]) {
      if (foundKey && stock[foundKey] !== undefined) {
        stock[foundKey] += qty;
        console.log(`ğŸ” Ø¥Ø±Ø¬Ø§Ø¹ ${qty} Ø¥Ù„Ù‰ ${name} (${foundKey})`);
      } else if (stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] !== undefined) {
        stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] += qty;
        console.log(`ğŸ” Ø¥Ø±Ø¬Ø§Ø¹ ${qty} Ø¥Ù„Ù‰ ${name} (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©)`);
      } else {
        totalQty += qty;
        console.log(`ğŸ” Ø¥Ø±Ø¬Ø§Ø¹ ${qty} Ø¥Ù„Ù‰ ${name} (Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙ‚Ø·)`);
      }
      processed[`return_${uniqueKey}`] = true;
    }

    // â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ù† ÙƒÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    totalQty = Object.values(stock).reduce((a, b) => a + (parseInt(b) || 0), 0);

    // ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ù…Ø®Ø²Ù†
    await update(warehouseRef, {
      stock,
      totalQty,
      processedOrders: processed,
      lastUpdate: new Date().toISOString(),
    });

    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${name}`, { totalQty, stock });
  }
};






    const firebaseConfig = {
      apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
      authDomain: "almurad-system.firebaseapp.com",
      databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
      projectId: "almurad-system",
      storageBucket: "almurad-system.appspot.com",
      messagingSenderId: "911755824405",
      appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
    };

   const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ordersBody = document.getElementById("ordersBody");
const searchInput = document.getElementById("searchInput");

// ğŸ”¹ Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
let currentUser = sessionStorage.getItem("userName");

// ğŸ”¸ ÙÙŠ Ø­Ø§Ù„ Ù…Ø§ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ session (Ù…Ø«Ù„Ø§Ù‹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©)
if (!currentUser) {
  const savedUser = localStorage.getItem("loggedInUser");
  if (savedUser) {
    const parsed = JSON.parse(savedUser);
    currentUser = parsed.name || parsed.username || parsed.displayName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  } else {
    currentUser = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  }
}



    let allProducts = [];
    let allOrders = [];
    const urlParams = new URLSearchParams(window.location.search);
    const currentStatus = decodeURIComponent(urlParams.get("status") || "");

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    // ğŸŸ¢ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ "warehouse"
const productsRef = ref(db, "warehouse");
onValue(productsRef, (snapshot) => {
  if (snapshot.exists()) {
    const data = snapshot.val();
    // ÙƒÙ„ Ù…Ù†ØªØ¬ Ù…ÙØªØ§Ø­Ù‡ Ù‡Ùˆ Ø§Ø³Ù…Ù‡ Ù…Ø«Ù„ "Ø¨ÙˆØºØ§ØªÙŠ"
    allProducts = Object.keys(data); 
  } else {
    allProducts = [];
  }
});

// âœ… Ù…ØªØºÙŠØ± Ø¹Ø§Ù… ÙŠØ®Ø²Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø­ØªÙ‰ Ù†Ø¹Ø±Ù Ø¥Ø°Ø§ Ø¯Ø®Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
let previousOrderCount = 0;

// ğŸŸ¢ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© + ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹Ø§Ù‹
const ordersRef = ref(db, "orders");
onValue(ordersRef, (snapshot) => {
  if (!snapshot.exists()) {
    ordersBody.innerHTML = `<tr><td colspan="17">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>`;
    return;
  }

  // ğŸ”¹ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
  const data = snapshot.val();
  allOrders = Object.entries(data).map(([id, order]) => ({ id, ...order }));

 // ğŸ”¹ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¹Ø¯Ø¯ Ù„Ù…Ø¹Ø±ÙØ© Ø¥Ø°Ø§ Ø£ÙƒÙˆ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
const currentCount = Object.keys(data).length;

// âœ… Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¢Ù† ÙŠØ´ØªØºÙ„ ÙÙŠ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª (Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ø­Ø§Ù„Ø©)
if (previousOrderCount && currentCount > previousOrderCount) {
  const diff = currentCount - previousOrderCount;
  showNewOrderNotification(diff);
}

// âœ… Ù†Ø­Ø¯Ø« Ø§Ù„Ø¹Ø¯Ø¯ Ø­ØªÙ‰ Ù„Ø§ ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
previousOrderCount = currentCount;


  previousOrderCount = currentCount;

  // ğŸ”¹ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
  refreshVisibleOrders();
});
function showNewOrderNotification(count = 1) {
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…
  const oldBar = document.getElementById("newOrderBar");
  if (oldBar) oldBar.remove();

  // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  const bar = document.createElement("div");
  bar.id = "newOrderBar";
  bar.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;animation:fadeInUp 0.4s ease">
      <span style="font-size:28px;background:#fff;color:#28a745;border-radius:50%;
      width:46px;height:46px;display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 10px rgba(255,255,255,0.3)">ğŸ’µ</span>
      <div>
        <div style="font-weight:bold;font-size:16px;">ÙˆØµÙ„ ${count} Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯${count>1?"Ø§Øª":""}!</div>
        <div style="font-size:13px;opacity:0.9;">ØªØ­Ù‚Ù‚ Ø§Ù„Ø¢Ù† Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
      </div>
    </div>
  `;
  Object.assign(bar.style, {
    position: "fixed",
    bottom: "25px",
    right: "25px",
    background: "linear-gradient(135deg,#28a745,#20c997)",
    color: "white",
    padding: "14px 22px",
    borderRadius: "16px",
    fontFamily: "Tajawal, sans-serif",
    boxShadow: "0 8px 25px rgba(0,0,0,0.3)",
    zIndex: "999999",
    cursor: "pointer",
    opacity: "1",
    transition: "all 0.6s ease"
  });
  document.body.appendChild(bar);

 if (window.soundAllowed) {
const audio = new Audio("cash-register-kaching.mp3");
  audio.volume = 1.0;
  audio.play().catch(err => console.warn("ğŸ”‡ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", err));
}




  // âœ¨ ØªÙØ§Ø¹Ù„ Ø¬Ù…ÙŠÙ„
  bar.addEventListener("mouseenter",()=>bar.style.transform="scale(1.05)");
  bar.addEventListener("mouseleave",()=>bar.style.transform="scale(1)");

  // â³ ÙŠØ®ØªÙÙŠ Ø¨Ø¹Ø¯ 6 Ø«ÙˆØ§Ù†Ù
  setTimeout(()=>{
    bar.style.opacity="0";
    bar.style.transform="translateY(20px)";
    setTimeout(()=>bar.remove(),600);
  },6000);

  const style=document.createElement("style");
  style.textContent=`
    @keyframes fadeInUp {
      from {opacity:0;transform:translateY(40px);}
      to {opacity:1;transform:translateY(0);}
    }`;
  document.head.appendChild(style);
}




// ğŸ”„ Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
function refreshVisibleOrders() {
  const filtered = allOrders.filter(o => {
    const st = (o.status || "").trim();
    return currentStatus === "" 
      ? (st === "" || st === null)
      : st === currentStatus;
  });

  renderOrders(filtered);
}


function createEditableInput(value, onSave, fieldName = "") {
  const input = document.createElement("input");
  input.value = value || "";

  // ğŸ§  Ù†Ø®Ù„ÙŠ Ø§Ù„ÙØ§ØµÙ„Ø© ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ø­Ù‚Ù„ Ø§Ø³Ù…Ù‡ Ø§Ù„Ø³Ø¹Ø± Ø£Ùˆ Ø§Ù„Ø¹Ø¯Ø¯
  if (fieldName === "price" || fieldName === "quantity") {
    input.addEventListener("input", e => {
      let val = e.target.value.replace(/[^\d]/g, "");
      if (val) {
        e.target.value = new Intl.NumberFormat("en-US").format(val);
      }
    });
    input.addEventListener("change", e => {
      const cleanValue = e.target.value.replace(/,/g, "");
      onSave(cleanValue);
    });
  } else {
    // ğŸŸ  Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ÙØ§ØµÙ„Ø©
    input.addEventListener("change", e => onSave(e.target.value));
  }

  return input;
}



    function createTextarea(value, onSave) {
      const t = document.createElement("textarea");
      t.value = value || "";
      t.addEventListener("change", e => onSave(e.target.value));
      return t;
    }
// âœ… Ø¯Ø§Ù„Ø© Ù…Ù†Ø³Ø¯Ù„Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ÙƒØªØ§Ø¨Ø© + Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function createDropdown(options, selected, onChange) {
  const wrapper = document.createElement("div");
  wrapper.style.position = "relative";

  const input = document.createElement("input");
  input.type = "text";
  input.value = selected || "";
  input.placeholder = "Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø®ØªØ±...";
  input.style.cursor = "text";
  input.style.width = "100%";
  input.style.borderRadius = "4px";
  input.style.padding = "4px";
  input.style.border = "1px solid #ccc";
  input.style.background = "#fff";
  input.style.fontSize = "12px";

  // âš™ï¸ Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
  const dropdown = document.createElement("div");
  Object.assign(dropdown.style, {
    position: "fixed",
    background: "#fff",
    border: "1px solid #ccc",
    borderRadius: "6px",
    boxShadow: "0 3px 10px rgba(0,0,0,0.25)",
    maxHeight: "200px",
    overflowY: "auto",
    zIndex: "9999999",
    display: "none",
    fontSize: "13px"
  });
  document.body.appendChild(dropdown);

  // ğŸ”¹ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  function showDropdown(filter = "") {
    dropdown.innerHTML = "";
    const filtered = options.filter(o => o.includes(filter));
    if (filtered.length === 0) {
      const noRes = document.createElement("div");
      noRes.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬";
      noRes.style.padding = "6px 10px";
      dropdown.appendChild(noRes);
    } else {
      filtered.forEach(o => {
        const opt = document.createElement("div");
        opt.textContent = o;
        opt.style.padding = "5px 8px";
        opt.style.cursor = "pointer";
        opt.addEventListener("click", () => {
          input.value = opt.textContent.trim();
          dropdown.style.display = "none";
          if (onChange) onChange(opt.textContent.trim());
        });
        dropdown.appendChild(opt);
      });
    }

    const rect = input.getBoundingClientRect();
const scrollY = window.scrollY || document.documentElement.scrollTop;
const scrollX = window.scrollX || document.documentElement.scrollLeft;
const dropdownHeight = 200;
const spaceBelow = window.innerHeight - rect.bottom;

// âœ… Ø¥Ø°Ø§ Ø§Ù„Ù…ÙƒØ§Ù† ØªØ­Øª Ø¶ÙŠÙ‚ØŒ ØªÙØªØ­ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ø¨Ù†ÙØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ù‚Ù„
let topPosition;
if (spaceBelow < dropdownHeight) {
  topPosition = rect.top + scrollY - dropdownHeight - 5; // ØªÙØªØ­ ÙÙˆÙ‚ Ø¨Ø´ÙƒÙ„ Ù…Ø±ØªØ¨
} else {
  topPosition = rect.bottom + scrollY + 3; // ØªÙØªØ­ ØªØ­Øª Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ
}

dropdown.style.position = "absolute";
dropdown.style.top = `${topPosition}px`;
dropdown.style.left = `${rect.left + scrollX}px`;
dropdown.style.width = `${rect.width}px`;
dropdown.style.display = "block";
dropdown.style.zIndex = "9999999";

  }

  // ğŸ§  Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
  input.addEventListener("focus", () => showDropdown(input.value.trim()));
  input.addEventListener("input", (e) => showDropdown(e.target.value.trim()));

  // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙƒØªØ§Ø¨Ø© Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„Ø¥Ù†ØªØ±
  input.addEventListener("keydown", (ev) => {
    if (ev.key === "Enter" && input.value.trim()) {
      ev.preventDefault();
      dropdown.style.display = "none";
      if (onChange) onChange(input.value.trim());
    }
  });

  // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
  document.addEventListener("click", (e) => {
    if (!wrapper.contains(e.target)) dropdown.style.display = "none";
  });

  wrapper.appendChild(input);
  return wrapper;
}



// âœ… Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø®Ø§Ù†Ø© "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" Ù…Ø¹ Ø¨Ø­Ø« ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ ÙÙ‚Ø§Ø¹Ø§Øª
function createTagsDropdownCell(orderId, initialValue = "", options = [], onSave) {
  const td = document.createElement("td");

  const container = document.createElement("div");
  container.style.cssText = `
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 5px;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 4px;
    background: #fff;
    min-height: 34px;
    cursor: text;
  `;

  const input = document.createElement("input");
  input.type = "text";
  input.placeholder = "Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...";
  input.style.cssText = `
    border: none;
    outline: none;
    flex: 1;
    min-width: 80px;
    font-size: 12px;
  `;

  let tags = initialValue
    ? initialValue.split("ØŒ").map(t => t.trim()).filter(Boolean)
    : [];

  function renderTags() {
    container.innerHTML = "";
    tags.forEach((tag, index) => {
      const span = document.createElement("span");
      span.textContent = tag;
      span.style.cssText = `
        background: #043B64;
        color: white;
        border-radius: 20px;
        padding: 3px 10px;
        font-size: 11px;
        display: flex;
        align-items: center;
        gap: 5px;
      `;
      const remove = document.createElement("span");
      remove.textContent = "âœ–";
      remove.style.cursor = "pointer";
      remove.onclick = () => {
        tags.splice(index, 1);
        saveTags();
      };
      span.appendChild(remove);
      container.appendChild(span);
    });
    container.appendChild(input);
  }

  function saveTags() {
    const val = tags.join("ØŒ ");
    onSave(val);
    renderTags();
  }

  // ğŸ”½ Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬
  const dropdown = document.createElement("div");
  Object.assign(dropdown.style, {
    position: "fixed",
    background: "#fff",
    border: "1px solid #ccc",
    borderRadius: "6px",
    boxShadow: "0 3px 10px rgba(0,0,0,0.2)",
    maxHeight: "200px",
    overflowY: "auto",
    zIndex: "999999",
    display: "none",
    fontSize: "12px"
  });

  function showDropdown(filter = "") {
    dropdown.innerHTML = "";
    const filtered = options.filter(o => o.includes(filter));
    if (filtered.length === 0) {
      const noResult = document.createElement("div");
      noResult.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬";
      noResult.style.padding = "6px 10px";
      dropdown.appendChild(noResult);
    } else {
      filtered.forEach(o => {
        const opt = document.createElement("div");
        opt.textContent = o;
        opt.style.padding = "5px 8px";
        opt.style.cursor = "pointer";
        opt.addEventListener("click", () => {
          if (!tags.includes(o)) {
            tags.push(o);
            saveTags();
          }
          dropdown.style.display = "none";
          input.value = "";
        });
        dropdown.appendChild(opt);
      });
    }

    const rect = input.getBoundingClientRect();
const scrollY = window.scrollY || document.documentElement.scrollTop;
const scrollX = window.scrollX || document.documentElement.scrollLeft;
const dropdownHeight = 200;
const spaceBelow = window.innerHeight - rect.bottom;

// âœ… Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ Ù…ÙƒØ§Ù† ÙƒØ§ÙÙŠ ØªØ­Øª Ø§Ù„Ø­Ù‚Ù„ØŒ Ø®Ù„ÙŠ Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ØªØ·Ù„Ø¹ Ù„Ù„Ø£Ø¹Ù„Ù‰
let topPosition;
if (spaceBelow < dropdownHeight) {
  topPosition = rect.top + scrollY - dropdownHeight - 5; // Ù„Ù„Ø£Ø¹Ù„Ù‰
} else {
  topPosition = rect.bottom + scrollY + 3; // Ù„Ù„Ø£Ø³ÙÙ„
}

// âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨Ø¯ÙˆÙ† fixed Ø­ØªÙ‰ ØªØªØ¨Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±
dropdown.style.position = "absolute";
dropdown.style.top = `${topPosition}px`;
dropdown.style.left = `${rect.left + scrollX}px`;
dropdown.style.width = `${rect.width}px`;
dropdown.style.display = "block";
dropdown.style.zIndex = "9999999";

  }

  input.addEventListener("focus", () => showDropdown());
input.addEventListener("input", e => {
  const value = e.target.value.trim();
  showDropdown(value);

  // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ø¶Ø§ÙØ© Ù†Øµ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø¥Ù†ØªØ±
  input.onkeydown = (ev) => {
    if (ev.key === "Enter" && value) {
      ev.preventDefault();
      if (!tags.includes(value)) {
        tags.push(value);
        saveTags();
      }
      input.value = "";
      dropdown.style.display = "none";
    }
  };
});
  document.addEventListener("click", e => {
    if (!container.contains(e.target)) dropdown.style.display = "none";
  });

  container.appendChild(input);
  document.body.appendChild(dropdown);
  renderTags();
  td.appendChild(container);
  return td;
}

    // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    function renderOrders(orders) {
      ordersBody.innerHTML = "";
      if (orders.length === 0) {
        ordersBody.innerHTML = `<tr><td colspan="17">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©</td></tr>`;
        return;
      }

      orders.forEach((order, index) => {
        const tr = document.createElement("tr");
           // ğŸ›‘ Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø§Øª Ù…Ø¹ÙŠÙ†Ø© Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
  const user = JSON.parse(localStorage.getItem("loggedInUser")) || {};
  const roles = user.roles || [];
  const readOnlyStatuses = ["ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…", "Ø±Ø§Ø¬Ø¹", "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹"];
  const isReadOnly = readOnlyStatuses.includes(order.status?.trim());

  // ğŸ”’ Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ø£Ø¯Ù…Ù† ÙˆÙ„Ø§ Ù…Ø­Ø§Ø³Ø¨ØŒ ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø©
  if (!roles.includes("admin") && !roles.includes("accountant") && isReadOnly) {
    // Ù†Ø­ÙˆÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ù„Ù‰ Ù†ØµÙˆØµ Ø«Ø§Ø¨ØªØ© ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¥Ø¯Ø®Ø§Ù„)
    const cols = [
      order.code, order.phone1 || order.phone, order.phone2, order.city, order.area,
      order.address, order.price, order.quantity, order.productName, order.notes,
      order.receiptNum, order.status, order.orderDate, order.advertiser
    ];

    // ğŸ”¢ Ø±Ù‚Ù… ØªØ³Ù„Ø³Ù„ÙŠ
    const indexTd = document.createElement("td");
    indexTd.textContent = index + 1;

    // ğŸ” ØªÙØ§ØµÙŠÙ„
    const detailsTd = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "ğŸ” ØªÙØ§ØµÙŠÙ„";
    btn.style.background = "#FF6B2D";
    btn.onclick = () => openOrderDetailsInline(order);
    detailsTd.appendChild(btn);

    // âœ… Ù†Ø¶ÙŠÙ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    tr.appendChild(document.createElement("td")); // checkbox ÙØ§Ø±Øº
    tr.appendChild(indexTd);
    tr.appendChild(detailsTd);

    cols.forEach((val) => {
      const td = document.createElement("td");
      td.textContent = val || "-";
      tr.appendChild(td);
    });

    ordersBody.appendChild(tr);
    return; // â›” Ù†ÙˆÙ‚Ù Ù‡Ù†Ø§ØŒ Ù…Ø§ Ù†ÙƒÙ…Ù„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØªØ­Ø±ÙŠØ±
  }

        const areas = citiesData[order.city] || [];

        // âœ… Ø§Ø®ØªÙŠØ§Ø±
        const selectTd = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.dataset.id = order.id;
        selectTd.appendChild(checkbox);
        tr.appendChild(selectTd);

        // ğŸ”¢ ØªØ³Ù„Ø³Ù„
        const indexTd = document.createElement("td");
        indexTd.textContent = index + 1;
        tr.appendChild(indexTd);

        // ğŸ” ØªÙØ§ØµÙŠÙ„
        const detailsTd = document.createElement("td");
        const detailsBtn = document.createElement("button");
        detailsBtn.textContent = "ğŸ” ØªÙØ§ØµÙŠÙ„";
        detailsBtn.style.background = "#FF6B2D";
detailsBtn.addEventListener("click", () => {
  const modal = document.getElementById("detailsModal");
  const frame = document.getElementById("detailsFrame");

localStorage.setItem("selectedOrder", order.id);

// âœ… Ù†Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…Ø«Ù„ "Ù…Ø«Ø¨Øª" Ø£Ùˆ "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©")
localStorage.setItem("lastStatusView", currentStatus);

// âœ… Ù†Ø±Ø³Ù„Ù‡Ø§ Ø£ÙŠØ¶Ù‹Ø§ ÙƒÙ€ query ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ø­ØªÙ‰ ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ ØªØ¹Ø±ÙÙ‡Ø§
frame.src = `order-details.html?id=${order.id}&status=${encodeURIComponent(currentStatus)}`;

  modal.style.display = "block";


// Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
function handleCloseModal(e) {
  if (e.data === "closeDetailsModal") {
    modal.style.display = "none";
    frame.src = "";
    window.removeEventListener("message", handleCloseModal);
  }
}
window.addEventListener("message", handleCloseModal);

});

        detailsTd.appendChild(detailsBtn);
        tr.appendChild(detailsTd);

        // Ø¨Ù‚ÙŠØ© Ø§Ù„Ø­Ù‚ÙˆÙ„
        const fields = [
          { val: order.code, fn: v => update(ref(db, `orders/${order.id}`), { code: v }) },
          { val: order.phone1 || order.phone, fn: v => update(ref(db, `orders/${order.id}`), { phone1: v }) },
          { val: order.phone2, fn: v => update(ref(db, `orders/${order.id}`), { phone2: v }) },
          { city: true },
          { area: true },
          { val: order.address, textarea: true, fn: v => update(ref(db, `orders/${order.id}`), { address: v }) },
          { val: order.price, fn: v => update(ref(db, `orders/${order.id}`), { price: v }) },
          { val: order.quantity, fn: v => update(ref(db, `orders/${order.id}`), { quantity: v }) },
{
  val: order.productName || order.product,
  customRender: "tagsInput",
  fn: v => update(ref(db, `orders/${order.id}`), { productName: v })
},

          { val: order.notes, textarea: true, fn: v => update(ref(db, `orders/${order.id}`), { notes: v }) },
          { val: order.receiptNum, fn: v => update(ref(db, `orders/${order.id}`), { receiptNum: v }) },
          {
   val: order.status || "",
  // âœ… Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ ÙÙ‚Ø·
  dropdown: [
    "Ù…Ø«Ø¨Øª",
    "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©",
    "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©",
    "Ø±ÙØ¶"
  ],
  fn: async (newStatus) => {

  console.log("ğŸ§  ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©:", newStatus);
  const userName = currentUser;
  const orderRef = ref(db, `orders/${order.id}`);
  const snap = await get(orderRef);
  const existing = snap.exists() ? snap.val() : {};

  // ğŸ§± Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®
  const historyEntry = {
    status: newStatus,
    by: userName,
    at: new Date().toISOString(),
  };

  const updates = {
    status: newStatus,
    updatedBy: userName,
    updatedAt: new Date().toISOString(),
    statusHistory: [...(existing.statusHistory || []), historyEntry],
  };

  if (newStatus === "Ù…Ø«Ø¨Øª" || newStatus === "Ø±ÙØ¶") {
    updates.fixedBy = userName;
  }

  // âœ… Ù†Ø­ÙØ¸ Ø£ÙˆÙ„Ø§Ù‹ Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ù†Ø§Ù‚ØµØ©
  if (["Ù…Ø«Ø¨Øª", "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„"].includes(newStatus)) {
    await ensureOrderDetailsSaved(order.id);
  }

  // ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„Ù€ Realtime
  await update(orderRef, updates);
  console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ${newStatus}`);

  // ğŸ§© Ø¥Ø°Ø§ Ø§Ù„Ø­Ø§Ù„Ø© ØªØªØ·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
  if (["Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„", "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹"].includes(newStatus)) {
    console.log("ğŸš€ ØªÙ†ÙÙŠØ° ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„:", newStatus);
    await adjustStockOnStatusChange(order.id, newStatus);
  }

  // ğŸ”» Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ø°Ø§ Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const st = (newStatus || "").trim();
  const shouldHide =
    (currentStatus === "" && st !== "") ||
    (currentStatus !== "" && st !== currentStatus);
  if (shouldHide) tr.remove();
}

},
          { val: order.orderDate || "-", readonly: true },
          { val: order.advertiser, fn: v => update(ref(db, `orders/${order.id}`), { advertiser: v }) }
        ];
function createProductTagsCell(productName) {
  const td = document.createElement("td");
  if (!productName) {
    td.textContent = "-";
    return td;
  }

  const products = productName.split("ØŒ").map(p => p.trim());
  products.forEach(name => {
    const tag = document.createElement("span");
    tag.textContent = name;
    tag.style.cssText = `
      display: inline-block;
      background: #043B64;
      color: white;
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 11px;
      margin: 2px;
      white-space: nowrap;
    `;
    td.appendChild(tag);
  });
  return td;
}

        fields.forEach(f => {
  let td;

 if (f.customRender === "tagsInput") {
  td = createTagsDropdownCell(order.id, order.productName || "", allProducts, async (newVal) => {
    const orderRef = ref(db, `orders/${order.id}`);

    // ğŸ§  Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹
    const snap = await get(orderRef);
    const existing = snap.exists() ? snap.val() : {};

    // âœ… ØªØ­Ø¯ÙŠØ« productName Ù…Ø¨Ø§Ø´Ø±Ø©
    const updates = { productName: newVal };

    // âœ… ØªØ­Ø¯ÙŠØ« productsDetailed (Ù†Ù†Ø´Ø¦Ù‡ Ù„Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯)
    if (!existing.productsDetailed || !Array.isArray(existing.productsDetailed) || existing.productsDetailed.length === 0) {
      updates.productsDetailed = [{ name: newVal, qty: existing.quantity || 1 }];
    } else {
      // Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù†Ø­Ø¯Ø« Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø·
      existing.productsDetailed[0].name = newVal;
      updates.productsDetailed = existing.productsDetailed;
    }

    // ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„Ù€ Realtime
    await update(orderRef, updates);
    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ "${newVal}" ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª`);
  });
}



else {
    td = document.createElement("td");
    if (f.readonly) td.textContent = f.val || "-";
    else if (f.textarea) td.appendChild(createTextarea(f.val, f.fn));
    else if (f.dropdown) td.appendChild(createDropdown(f.dropdown, f.val, f.fn));
    else if (f.city) {
      const cityDropdown = createDropdown(allCities, order.city || "", val => update(ref(db, `orders/${order.id}`), { city: val, area: "" }));
      td.appendChild(cityDropdown);
    } else if (f.area) {
      const areaDropdown = createDropdown(areas, order.area || "", val => update(ref(db, `orders/${order.id}`), { area: val }));
      td.appendChild(areaDropdown);
    } else td.appendChild(createEditableInput(f.val, f.fn, f.name || ""));

  }

  tr.appendChild(td);
});


        ordersBody.appendChild(tr);
      });
    }

    // ğŸ” Ø§Ù„Ø¨Ø­Ø«
    searchInput.addEventListener("input", e => {
      const q = e.target.value.trim();
      const filtered = allOrders.filter(o => Object.values(o).some(v => v && v.toString().includes(q)));
      renderOrders(filtered);
    });

    // ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    document.getElementById("deleteSelected").addEventListener("click", () => {
      const checked = Array.from(document.querySelectorAll("input[type='checkbox']:checked"));
      if (checked.length === 0) return alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª!");
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŸ")) return;
      checked.forEach(ch => remove(ref(db, `orders/${ch.dataset.id}`)));
      alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");
    });

    document.getElementById("backBtn").addEventListener("click", () => window.location.href = "dashboard.html");



// ğŸšš Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ· (Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ù‘Ø«Ø©)
// ğŸšš Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ· (Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ø±Ø© ÙˆÙ…Ø¬Ø±Ø¨Ø©)
// ğŸš€ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© ÙˆØ§Ø­Ø¯Ø© ØªÙ„Ùˆ Ø§Ù„Ø£Ø®Ø±Ù‰ (Ù†Ø³Ø®Ø© Ø£ØµÙ„ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø©)
document.getElementById("sendToWaseet").addEventListener("click", async () => {
  // ğŸŸ© Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰
  let statusBar = document.getElementById("statusBar");
  if (!statusBar) {
    statusBar = document.createElement("div");
    statusBar.id = "statusBar";
    Object.assign(statusBar.style, {
      position: "fixed",
      top: "0",
      right: "0",
      left: "0",
      padding: "12px",
      textAlign: "center",
      backgroundColor: "#043B64",
      color: "white",
      fontSize: "15px",
      fontWeight: "bold",
      zIndex: "999999",
      transition: "0.4s ease"
    });
    document.body.appendChild(statusBar);
  }
  const showMsg = (text, color = "#043B64") => {
    statusBar.textContent = text;
    statusBar.style.backgroundColor = color;
    statusBar.style.display = "block";
  };

  try {
    showMsg("â³ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·...");

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†
    const loginResponse = await fetch("https://almurad.onrender.com/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: "ramadan@almurad",
        password: "ramadan1998@"
      })
    });

    const loginData = await loginResponse.json();
    const token = loginData.data?.token;
    if (!token) {
      showMsg("âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·", "#b30000");
      return;
    }

    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© ÙÙ‚Ø·
    const confirmedOrders = allOrders.filter(o => (o.status || "").trim() === "Ù…Ø«Ø¨Øª");
    if (confirmedOrders.length === 0) {
      showMsg("âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø«Ø¨ØªØ© Ø­Ø§Ù„ÙŠØ§Ù‹.", "#28a745");
      setTimeout(() => (statusBar.style.display = "none"), 2500);
      return;
    }

    let sentCount = 0, failedCount = 0;
    showMsg(`ğŸš€ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${confirmedOrders.length} Ø·Ù„Ø¨...`);

    // Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ø­Ø¯Ø§Ù‹ ØªÙ„Ùˆ Ø§Ù„Ø¢Ø®Ø±
    for (const order of confirmedOrders) {
      try {
        const cityMatch = waseetCities.find(c => c.city_name === order.city);
        const regionMatch = waseetRegions.find(r => r.region_name === order.area);
        const cityId = cityMatch ? cityMatch.id : "";
        const regionId = regionMatch ? regionMatch.id : "";

        if (!cityId || !regionId) {
          failedCount++;
          continue;
        }

        const payload = {
          token,
          client_name: order.code || "Ø²Ø¨ÙˆÙ†",
          client_mobile: normalizePhone(order.phone1 || ""),
          client_mobile2: order.phone2 ? normalizePhone(order.phone2) : "",
          city_id: cityId,
          region_id: regionId,
          location: order.address || "",
          type_name: order.productName || "Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
          items_number: order.quantity?.toString() || "1",
          price: order.price?.toString() || "0",
          package_size: "1",
          merchant_notes: order.notes || "",
          replacement: 0,
        };

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„ÙˆØ³ÙŠØ· (Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø³ÙŠØ±ÙØ±Ùƒ Ø§Ù„Ø®Ø§Øµ)
        const response = await fetch("https://almurad.onrender.com/api/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await response.json();
        console.log("ğŸ“¬ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ÙˆØ³ÙŠØ·:", data);

        if (data.status === true && data.data?.qr_id) {
          await update(ref(db, `orders/${order.id}`), {
            status: "Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²",
            receiptNum: data.data.qr_id.toString(),
            waseet_link: data.data.qr_link,
          });
          sentCount++;
        } else {
          failedCount++;
        }
      } catch (err) {
        failedCount++;
        console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨:", err);
      }
    }

    showMsg(`âœ… ØªÙ… Ø±ÙØ¹ ${sentCount} Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ØŒ âŒ ÙØ´Ù„ ${failedCount}.`, "#28a745");
    setTimeout(() => (statusBar.style.display = "none"), 4000);
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:", err);
    showMsg("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.", "#b30000");
  }
});



// ğŸ”¢ Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
function normalizePhone(phone) {
  const arabicToEnglish = {
    'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4',
    'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9'
  };
  let cleaned = phone.replace(/[^\dÙ -Ù©]/g, '');
  cleaned = cleaned.split('').map(c => arabicToEnglish[c] || c).join('');
  if (cleaned.startsWith("0")) return "+964" + cleaned.slice(1);
  if (cleaned.startsWith("7")) return "+964" + cleaned;
  if (!cleaned.startsWith("+964")) return "+964" + cleaned;
  return cleaned;
}
// ğŸ”½ Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ÙˆØ³ÙŠØ·
const commandsBtn = document.getElementById("commandsBtn");
const commandsMenu = document.getElementById("commandsMenu");

commandsBtn.addEventListener("click", () => {
  commandsMenu.classList.toggle("show");
});

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
window.addEventListener("click", (e) => {
  if (!commandsBtn.contains(e.target)) commandsMenu.classList.remove("show");
});

// ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ³ÙŠØ·
// ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ³ÙŠØ· (Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù‘Ù†Ø©)
// ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ³ÙŠØ· (Bulk - ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©)
document.getElementById("updateStatuses").addEventListener("click", async () => {
  // ğŸŸ© Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  let statusBar = document.getElementById("statusBar");
  if (!statusBar) {
    statusBar = document.createElement("div");
    statusBar.id = "statusBar";
    Object.assign(statusBar.style, {
      position: "fixed",
      top: "0",
      right: "0",
      left: "0",
      padding: "12px",
      textAlign: "center",
      backgroundColor: "#043B64",
      color: "white",
      fontSize: "15px", 
      fontWeight: "bold",
      zIndex: "999999",
      transition: "0.4s ease"
    });
    document.body.appendChild(statusBar);
  }
  function showMsg(text, color = "#043B64") {
    statusBar.textContent = text;
    statusBar.style.backgroundColor = color;
    statusBar.style.display = "block";
  }

  try {
    showMsg("â³ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·...");

    // ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†
    const loginResponse = await fetch("https://almurad.onrender.com/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: "ramadan@almurad",
        password: "ramadan1998@"
      })
    });

    const loginData = await loginResponse.json();
    const token = loginData.data?.token;
    if (!token) {
      showMsg("âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·", "#b30000");
      return;
    }

    // ğŸŸ  Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙ‚Ø·
    const allowedToCheck = ["Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²", "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„", "Ø±Ø§Ø¬Ø¹"];

    // ğŸ§© Ø§Ù„Ù…Ø§Ø¨ÙŠÙ†Ú¯ Ø¨ÙŠÙ† Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙˆØ³ÙŠØ· ÙˆØ­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    const statusMapping = {
      "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù„Ø²Ø¨ÙˆÙ†": "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
      "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨": "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„",
      "Ø§Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±": "Ø±Ø§Ø¬Ø¹",
      "ØªÙ… Ø§Ù„Ø§Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±": "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹",
      "ÙÙŠ Ù…ÙˆÙ‚Ø¹ ÙØ±Ø² Ø¨ØºØ¯Ø§Ø¯": "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„"
    };

    // ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ« ÙÙ‚Ø·
    const ordersToUpdate = allOrders.filter(
      o => allowedToCheck.includes((o.status || "").trim()) && o.receiptNum
    );

    if (ordersToUpdate.length === 0) {
      showMsg("âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ«.", "#28a745");
      setTimeout(() => (statusBar.style.display = "none"), 2500);
      return;
    }

    showMsg(`ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« ${ordersToUpdate.length} Ø·Ù„Ø¨ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©...`);

    // ğŸ§¾ ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
    const allIds = ordersToUpdate.map(o => o.receiptNum).join(",");

    // ğŸ“¡ Ø¥Ø±Ø³Ø§Ù„ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø³ÙŠØ±ÙØ±
    const response = await fetch("https://almurad.onrender.com/api/get-orders-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token, ids: allIds })
    });

    const data = await response.json();

    if (!data.status || !data.data) {
      showMsg("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ³ÙŠØ·.", "#b30000");
      return;
    }

    let updatedCount = 0;

    // ğŸ” ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙƒÙ„Ù‡Ø§ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø§Ù„Ù€ Firebase
    for (const orderData of data.data) {
      const apiStatus = (orderData.status || "").trim();
      const mappedStatus = statusMapping[apiStatus] || null;
      if (!mappedStatus) continue;

      const targetOrder = allOrders.find(
        o => (o.receiptNum || "").toString() === orderData.id.toString()
      );
      if (targetOrder) {
        await update(ref(db, `orders/${targetOrder.id}`), {
          status: mappedStatus
        });
        updatedCount++;
  // âœ… Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ØªØ­ÙˆÙ„Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„"
  if (mappedStatus === "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„" || mappedStatus === "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹") {
    await adjustStockOnStatusChange(targetOrder.id, mappedStatus);
  }

        if (apiStatus === "ÙÙŠ Ù…ÙˆÙ‚Ø¹ ÙØ±Ø² Ø¨ØºØ¯Ø§Ø¯") {
          await update(ref(db, `orders/${targetOrder.id}`), {
            notes:
              (targetOrder.notes || "") +
              (targetOrder.notes ? " | " : "") +
              "ØªØ­ÙˆÙ„Øª Ù…Ù† Ù…ÙˆÙ‚Ø¹ ÙØ±Ø²"
          });
        }
      }
    }

    showMsg(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedCount} Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.`, "#28a745");
    setTimeout(() => (statusBar.style.display = "none"), 3000);
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª:", err);
    showMsg("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª.", "#b30000");
  }
});
// âœ… Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©
function openOrderDetailsInline(order) {
  const overlay = document.createElement("div");
  Object.assign(overlay.style, {
    position: "fixed",
    top: "0", left: "0", right: "0", bottom: "0",
    background: "rgba(0,0,0,0.4)",
    display: "flex",
    justifyContent: "center",
    alignItems: "center",
    zIndex: "999999"
  });

  const box = document.createElement("div");
  Object.assign(box.style, {
    background: "white",
    borderRadius: "10px",
    padding: "20px",
    width: "90%",
    maxWidth: "600px",
    maxHeight: "90%",
    overflowY: "auto",
    direction: "rtl",
    textAlign: "right"
  });

  box.innerHTML = `
    <h3 style="text-align:center;color:#043B64;margin-top:0;">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
    <p><b>Ø§Ù„ÙƒÙˆØ¯:</b> ${order.code || "-"}</p>
    <p><b>Ø§Ù„Ù…Ù†ØªØ¬:</b> ${order.productName || "-"}</p>
    <p><b>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</b> ${order.city || "-"}</p>
    <p><b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${order.area || "-"}</p>
    <p><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${order.address || "-"}</p>
    <p><b>Ø§Ù„Ø³Ø¹Ø±:</b> ${order.price || "-"}</p>
    <p><b>Ø§Ù„ÙƒÙ…ÙŠØ©:</b> ${order.quantity || "-"}</p>
    <p><b>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${order.notes || "-"}</p>
    <p><b>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</b> ${order.phone1 || "-"}</p>
    <p><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${order.status || "-"}</p>
    <p><b>Ø§Ù„Ù…Ø¹Ù„Ù†:</b> ${order.advertiser || "-"}</p>
    <div style="text-align:center;margin-top:20px;">
      <button id="closeOrderModal" style="background:#043B64;color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  `;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  document.getElementById("closeOrderModal").addEventListener("click", () => overlay.remove());
}


// âœ… Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const currentStatusName = decodeURIComponent(urlParams.get("status") || "");
  const pageStatusTitle = document.getElementById("pageStatusTitle");

  if (pageStatusTitle) {
    if (currentStatusName) {
      pageStatusTitle.textContent = `ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª - ${currentStatusName}`;
    } else {
      pageStatusTitle.textContent = "ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©";
    }
  }
});

// ğŸ§© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ¶Ø¹ Ø³Ø§Ø¨Ù‚ Ù†Ø±Ø¬Ø¹ Ù„Ù‡
document.addEventListener("DOMContentLoaded", () => {
  const restoreScroll = localStorage.getItem("restoreScrollAfterReturn");
  if (restoreScroll) {
    window.scrollTo(0, parseInt(restoreScroll));
    localStorage.removeItem("restoreScrollAfterReturn");
  }
});
</script>

  <!-- âœ… Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ù…Ù†Ø³ÙˆØ®Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„) -->
  <div id="detailsModal" style="display:none;">
    <iframe id="detailsFrame" style="
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      border:none;
      z-index:999999;
    "></iframe>
  </div>
<!-- âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨ØµÙ…Øª Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø¶ØºØ·Ø© ÙÙ‚Ø· -->
<script>
document.addEventListener("click", () => {
  if (!window.soundAllowed) {
    window.soundAllowed = true;
  }
}, { once: true }); // â† ÙŠØ¹Ù†ÙŠ ÙŠØ´ØªØºÙ„ Ù…Ø±Ø© ÙˆØ­Ø¯Ø© ÙÙ‚Ø·
</script>

</script>
<script>
// âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„
document.addEventListener("click", () => {
  if (!window.soundAllowed) {
    window.soundAllowed = true;
    console.log("ğŸ”Š ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ù†Ø¬Ø§Ø­");
  }
}, { once: true });

// âœ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ø¹ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
function playNotificationSound() {
  if (!window.soundAllowed) return; // ğŸ”‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ ÙØ¹Ù„ Ø§Ù„ØµÙˆØª Ø¨Ø¹Ø¯
  const audio = new Audio("cash-register-kaching.mp3");
  audio.volume = 1.0;
  audio.play().catch(err => console.warn("ğŸ”‡ Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", err));
}

// âœ… ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„ØªØ´ØºÙ„ Ø§Ù„ØµÙˆØª Ø¯Ø§Ø¦Ù…Ù‹Ø§
window.showNewOrderNotification = function(count = 1) {
  const oldBar = document.getElementById("newOrderBar");
  if (oldBar) oldBar.remove();

  const bar = document.createElement("div");
  bar.id = "newOrderBar";
  bar.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;animation:fadeInUp 0.4s ease">
      <span style="font-size:28px;background:#fff;color:#28a745;border-radius:50%;
      width:46px;height:46px;display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 10px rgba(255,255,255,0.3)">ğŸ’µ</span>
      <div>
        <div style="font-weight:bold;font-size:16px;">ÙˆØµÙ„ ${count} Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯${count>1?"Ø§Øª":""}!</div>
        <div style="font-size:13px;opacity:0.9;">ØªØ­Ù‚Ù‚ Ø§Ù„Ø¢Ù† Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
      </div>
    </div>
  `;
  Object.assign(bar.style, {
    position: "fixed",
    bottom: "25px",
    right: "25px",
    background: "linear-gradient(135deg,#28a745,#20c997)",
    color: "white",
    padding: "14px 22px",
    borderRadius: "16px",
    fontFamily: "Tajawal, sans-serif",
    boxShadow: "0 8px 25px rgba(0,0,0,0.3)",
    zIndex: "999999",
    cursor: "pointer",
    opacity: "1",
    transition: "all 0.6s ease"
  });
  document.body.appendChild(bar);

  // ğŸ”Š ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙˆØ±Ø§Ù‹ Ù…Ø¹ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  playNotificationSound();

  // âœ¨ ØªØ£Ø«ÙŠØ± Ø¨Ø³ÙŠØ·
  bar.addEventListener("mouseenter",()=>bar.style.transform="scale(1.05)");
  bar.addEventListener("mouseleave",()=>bar.style.transform="scale(1)");

  // â³ ÙŠØ®ØªÙÙŠ Ø¨Ø¹Ø¯ 6 Ø«ÙˆØ§Ù†Ù
  setTimeout(()=>{
    bar.style.opacity="0";
    bar.style.transform="translateY(20px)";
    setTimeout(()=>bar.remove(),600);
  },6000);
};
</script>
<!-- âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª + Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
<script>
/* ğŸ”¹ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø£ÙˆÙ„ Ù„Ù…Ø³Ø© */
document.addEventListener("click", function enableSoundOnce() {
  const silent = new Audio("cash-register-kaching.mp3");
  silent.volume = 0; // ØµÙˆØª ØµØ§Ù…Øª
  silent.play().catch(()=>{});
  window.soundAllowed = true;
  console.log("ğŸ”Š ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
  document.removeEventListener("click", enableSoundOnce);
}, { once: true });

/* ğŸ”¹ ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± + Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø·Ù„Ø¨ */
function playNotificationSound() {
  if (!window.soundAllowed) return; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ ÙØ¹Ù‘Ù„ Ø§Ù„ØµÙˆØª Ø¨Ø¹Ø¯
  try {
    const audio = new Audio("cash-register-kaching.mp3");
    audio.volume = 1.0;
    audio.play().catch(err => console.warn("ğŸ”‡ Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", err));

    // ğŸ“³ Ø§Ù‡ØªØ²Ø§Ø² Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…Ø¹Ø¸Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª)
    if (navigator.vibrate) {
      navigator.vibrate([100, 50, 150]); // ÙŠÙ‡ØªØ² 100ms Ø«Ù… ØªÙˆÙ‚Ù 50ms Ø«Ù… ÙŠÙ‡ØªØ² 150ms
    }
  } catch (err) {
    console.warn("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø£Ùˆ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²:", err);
  }
}

/* ğŸ”¹ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„ØªØ³ØªØ®Ø¯Ù… Ø§Ù„ØµÙˆØª + Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² */
window.showNewOrderNotification = function(count = 1) {
  const oldBar = document.getElementById("newOrderBar");
  if (oldBar) oldBar.remove();

  const bar = document.createElement("div");
  bar.id = "newOrderBar";
  bar.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;animation:fadeInUp 0.4s ease">
      <span style="font-size:28px;background:#fff;color:#28a745;border-radius:50%;
      width:46px;height:46px;display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 10px rgba(255,255,255,0.3)">ğŸ’µ</span>
      <div>
        <div style="font-weight:bold;font-size:16px;">ÙˆØµÙ„ ${count} Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯${count>1?"Ø§Øª":""}!</div>
        <div style="font-size:13px;opacity:0.9;">ØªØ­Ù‚Ù‚ Ø§Ù„Ø¢Ù† Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
      </div>
    </div>
  `;
  Object.assign(bar.style, {
    position: "fixed",
    bottom: "25px",
    right: "25px",
    background: "linear-gradient(135deg,#28a745,#20c997)",
    color: "white",
    padding: "14px 22px",
    borderRadius: "16px",
    fontFamily: "Tajawal, sans-serif",
    boxShadow: "0 8px 25px rgba(0,0,0,0.3)",
    zIndex: "999999",
    cursor: "pointer",
    opacity: "1",
    transition: "all 0.6s ease"
  });
  document.body.appendChild(bar);

  // ğŸ”ŠğŸ“³ ØµÙˆØª + Ø§Ù‡ØªØ²Ø§Ø² Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  playNotificationSound();

  // âœ¨ ØªÙØ§Ø¹Ù„
  bar.addEventListener("mouseenter",()=>bar.style.transform="scale(1.05)");
  bar.addEventListener("mouseleave",()=>bar.style.transform="scale(1)");

  setTimeout(()=>{
    bar.style.opacity="0";
    bar.style.transform="translateY(20px)";
    setTimeout(()=>bar.remove(),600);
  },6000);
};

// ğŸ§  Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù„ÙˆÙŠ
function showNotification(message, color = "#FF6B2D") {
  const existing = document.querySelector(".notification");
  if (existing) existing.remove();

  const note = document.createElement("div");
  note.className = "notification";
  note.style.background = color;
  note.textContent = message;

  document.body.appendChild(note);

  setTimeout(() => note.classList.add("show"), 50);
  setTimeout(() => {
    note.classList.remove("show");
    setTimeout(() => note.remove(), 300);
  }, 3000);
}
// âœ… Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù†ÙØ³ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ… ØªÙ…Ø§Ù…Ø§Ù‹
const lastStatus = localStorage.getItem("lastStatusView");
const lastScroll = localStorage.getItem("previousScrollPosition");

// ğŸ”¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ØŒ Ù†ØºÙ„Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
if (window.parent) {
  localStorage.setItem("restoreScrollAfterReturn", lastScroll || "0");
  window.parent.postMessage("closeDetailsModal", "*");
}

// âœ… Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙŠØ´ØªØºÙ„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
document.getElementById("backBtn").addEventListener("click", () => {
  if (window.parent) {
    window.parent.postMessage("closeDetailsModal", "*");
  }
});


</script>


</body>
</html>
