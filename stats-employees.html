<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>📊 لوحة الأداء الشاملة - نظام المراد</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --blue:#043B64;
  --orange:#FF6B2D;
  --bg:#f5f6fa;
}
body{font-family:'Tajawal',sans-serif;background:var(--bg);margin:0;color:#222}
header{background:var(--blue);color:#fff;text-align:center;padding:14px;font-weight:700}
.container{max-width:1200px;margin:20px auto;padding:16px}
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px;align-items:center;justify-content:center}
select,input{padding:8px;border:1px solid #ccc;border-radius:8px}
button{background:var(--blue);color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:600}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:20px}
.card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);text-align:center;transition:0.3s}
.card:hover{transform:translateY(-3px);box-shadow:0 4px 12px rgba(0,0,0,0.08)}
.card h3{margin:0;color:var(--blue);font-size:14px}
.card p{margin:6px 0 0;font-weight:700;font-size:20px}
.chart-container{background:#fff;border-radius:10px;padding:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
canvas{width:100%!important;height:auto!important}
.table-wrap{background:#fff;border-radius:8px;padding:10px;margin-top:18px;box-shadow:0 2px 8px rgba(0,0,0,0.05);overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:700px}
th,td{padding:8px;text-align:center;border-bottom:1px solid #eee}
th{background:#f9fafc;color:var(--blue)}
.tips{background:#fff;margin-top:16px;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
.hidden{display:none!important}
@media(max-width:768px){
  .charts{display:flex;flex-direction:column}
  .cards{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<header>👨‍💼 لوحة الأداء الشاملة - نظام المراد</header>

<div class="container">
  <div class="controls">
    <label>الموظف:</label>
    <select id="userSelect"></select>
    <label>من:</label>
    <input type="date" id="fromDate">
    <label>إلى:</label>
    <input type="date" id="toDate">
    <button id="applyBtn">تطبيق</button>
  </div>

  <!-- 🔸 لوحة التحكم بالعمولات -->
  <div class="table-wrap" id="commissionSection">
    <h3 style="color:var(--blue)">💰 تعديل العمولات لكل موظف</h3>
    <table id="commissionTable">
      <thead><tr><th>الموظف</th><th>العمولة لكل طلب (دينار)</th></tr></thead>
      <tbody></tbody>
    </table>
    <button id="saveCommission">💾 حفظ العمولات</button>
  </div>

  <div class="cards" id="statusCards"></div>
  
  <div class="chart-container">
    <canvas id="mainChart"></canvas>
  </div>

  <div class="table-wrap" id="summaryTableWrap">
    <h3 style="color:var(--blue)">📋 ملخص الموظفين</h3>
    <table id="summaryTable">
      <thead>
        <tr>
          <th>الموظف</th>
          <th>تم التسليم</th>
          <th>راجع</th>
          <th>رفض</th>
          <th>الإجمالي</th>
          <th>نسبة الإنجاز</th>
          <th>نسبة الراجع</th>
          <th>العمولة (دينار)</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><th colspan="7" style="text-align:right">💰 العمولة الكلية لجميع الموظفين:</th><th id="totalCommissionCell">0</th></tr>
      </tfoot>
    </table>
  </div>

  <div class="table-wrap" id="ordersWrap">
    <h3 style="color:var(--blue)">📦 تفاصيل الطلبات</h3>
    <table id="ordersTable">
      <thead>
        <tr>
          <th>#</th><th>الكود</th><th>المنتج</th><th>السعر</th>
          <th>المدينة</th><th>الحالة</th><th>التاريخ</th><th>الموظف</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="tips" id="tipsBox"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const config = {
  apiKey:"AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
  authDomain:"almurad-system.firebaseapp.com",
  databaseURL:"https://almurad-system-default-rtdb.firebaseio.com/",
  projectId:"almurad-system"
};
const app = initializeApp(config);
const db = getDatabase(app);

// 🧮 إعداد العمولات (يتم حفظها محليًا)
let commissionRates = JSON.parse(localStorage.getItem("commissionRates") || "{}");

const selectEl=document.getElementById('userSelect');
const fromEl=document.getElementById('fromDate');
const toEl=document.getElementById('toDate');
const applyBtn=document.getElementById('applyBtn');
const tbody=document.querySelector('#ordersTable tbody');
const summaryBody=document.querySelector('#summaryTable tbody');
const totalCommissionCell=document.getElementById('totalCommissionCell');
const cards=document.getElementById('statusCards');
const tipsBox=document.getElementById('tipsBox');
const commissionBody=document.querySelector('#commissionTable tbody');
const saveCommissionBtn=document.getElementById('saveCommission');
const commissionSection=document.getElementById('commissionSection');
const summaryTableWrap=document.getElementById('summaryTableWrap');
let chart;
let allOrders=[];

onValue(ref(db,'orders'),snap=>{
  if(!snap.exists())return;
  allOrders=Object.values(snap.val());
  populateUsers();
  render();
});

function populateUsers(){
  const users=[...new Set(allOrders.map(o=>o.fixedBy||'غير محدد'))];
  selectEl.innerHTML=`<option value="">كل الموظفين</option>`;
  commissionBody.innerHTML="";
  users.forEach(u=>{
    const opt=document.createElement('option');
    opt.value=u;opt.textContent=u;
    selectEl.appendChild(opt);

    // 🔸 تعبئة جدول العمولات
    const rate=commissionRates[u]||250;
    commissionBody.innerHTML+=`
      <tr>
        <td>${u}</td>
        <td><input type="number" id="rate_${u}" value="${rate}" style="width:100px"></td>
      </tr>`;
  });
}

saveCommissionBtn.onclick=()=>{
  const rows=document.querySelectorAll('#commissionTable tbody tr');
  rows.forEach(r=>{
    const name=r.cells[0].textContent;
    const rate=Number(r.querySelector('input').value)||0;
    commissionRates[name]=rate;
  });
  localStorage.setItem("commissionRates",JSON.stringify(commissionRates));
  alert("✅ تم حفظ العمولات بنجاح!");
  render();
};

applyBtn.onclick=()=>render();

function toDateObj(d){if(!d)return null;const n=new Date(d);return isNaN(n)?null:n;}

function render(){
  const from=fromEl.value?new Date(fromEl.value+'T00:00:00'):null;
  const to=toEl.value?new Date(toEl.value+'T23:59:59'):null;
  const user=selectEl.value;
  
  const filtered=allOrders.filter(o=>{
    const dt=toDateObj(o.updatedAt||o.orderDate)||new Date();
    if(from&&dt<from)return false;
    if(to&&dt>to)return false;
    if(user&&(o.fixedBy)!==user)return false;
    return true;
  });

  // إظهار/إخفاء الجداول حسب الاختيار
  if(user===""){
    commissionSection.classList.remove('hidden');
    summaryTableWrap.classList.remove('hidden');
    renderAllEmployees(filtered);
  } else {
    commissionSection.classList.add('hidden');
    summaryTableWrap.classList.add('hidden');
    renderSingleUser(filtered,user);
  }
}

function renderAllEmployees(filtered){
  const usersData={};
  filtered.forEach(o=>{
    const u=o.fixedBy||'غير محدد';
    usersData[u]=usersData[u]||{del:0,ret:0,rej:0,total:0};
    usersData[u].total++;
    if(o.status==="تم التسليم")usersData[u].del++;
    if(o.status==="راجع")usersData[u].ret++;
    if(o.status==="رفض")usersData[u].rej++;
  });

  const summary=[];
  for(const u in usersData){
    const d=usersData[u];
    const rate=d.total?((d.del/d.total)*100).toFixed(1):0;
    const retRate=d.total?((d.ret/d.total)*100).toFixed(1):0;
    const commission=(d.del*(commissionRates[u]||250));
    summary.push({u,rate,retRate,commission,...d});
  }
  summary.sort((a,b)=>b.rate-a.rate);

  const totalCommission=summary.reduce((a,b)=>a+b.commission,0);
  totalCommissionCell.textContent=totalCommission.toLocaleString();

  const ctx=document.getElementById('mainChart').getContext('2d');
  if(chart)chart.destroy();
  chart=new Chart(ctx,{
    type:'bar',
    data:{
      labels:summary.map(s=>s.u),
      datasets:[
        {label:'تم التسليم',data:summary.map(s=>s.del),backgroundColor:'#198754'},
        {label:'راجع',data:summary.map(s=>s.ret),backgroundColor:'#FF6B2D'},
        {label:'رفض',data:summary.map(s=>s.rej),backgroundColor:'#DC3545'}
      ]
    },
    options:{responsive:true,plugins:{legend:{position:'bottom'}}}
  });

  summaryBody.innerHTML=summary.map(s=>`
    <tr>
      <td>${s.u}</td>
      <td>${s.del}</td>
      <td>${s.ret}</td>
      <td>${s.rej}</td>
      <td>${s.total}</td>
      <td>${s.rate}%</td>
      <td>${s.retRate}%</td>
      <td>${s.commission.toLocaleString()}</td>
    </tr>
  `).join('');

  cards.innerHTML=`
    <div class="card"><h3>إجمالي الطلبات</h3><p>${filtered.length}</p></div>
    <div class="card"><h3>عدد الموظفين</h3><p>${Object.keys(usersData).length}</p></div>
    <div class="card"><h3>أفضل أداء</h3><p>${summary[0]?.u||'-'}</p></div>
    <div class="card"><h3>💰 العمولة الكلية</h3><p>${totalCommission.toLocaleString()}</p></div>
  `;

  tbody.innerHTML="";
  tipsBox.innerHTML=`<h3 style="color:var(--blue)">💡 توصيات عامة</h3>
  <p>تم عرض ${summary.length} موظف.</p>
  <p>أعلى نسبة إنجاز: <b>${summary[0]?.u}</b> (${summary[0]?.rate}%)</p>`;
}

function renderSingleUser(filtered,user){
  const counts={مثبت:0,"تم التسليم":0,راجع:0,رفض:0,total:0};
  filtered.forEach(o=>{const st=(o.status||"").trim();counts[st]=(counts[st]||0)+1;counts.total++;});
  const delivered=counts["تم التسليم"]||0;
  const returned=counts.راجع||0;
  const rejected=counts.رفض||0;
  const rate=counts.total?((delivered/counts.total)*100).toFixed(1):0;
  const returnRate=counts.total?((returned/counts.total)*100).toFixed(1):0;
  const commission=(delivered*(commissionRates[user]||250));

  cards.innerHTML=`
    <div class="card"><h3>📦 مثبت</h3><p>${counts.مثبت}</p></div>
    <div class="card"><h3>🚚 تم التسليم</h3><p>${delivered}</p></div>
    <div class="card"><h3>🔁 راجع</h3><p>${returned}</p></div>
    <div class="card"><h3>❌ رفض</h3><p>${rejected}</p></div>
    <div class="card"><h3>⭐ نسبة الإنجاز</h3><p>${rate}%</p></div>
    <div class="card"><h3>⚠️ نسبة الراجع</h3><p>${returnRate}%</p></div>
    <div class="card"><h3>💰 العمولة الكلية</h3><p>${commission.toLocaleString()}</p></div>
  `;

  const ctx=document.getElementById('mainChart').getContext('2d');
  if(chart)chart.destroy();
  chart=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['تم التسليم','راجع','رفض'],
      datasets:[{data:[delivered,returned,rejected],backgroundColor:['#198754','#FF6B2D','#DC3545']}]
    },
    options:{plugins:{legend:{position:'bottom'}}}
  });

  tbody.innerHTML="";
  filtered.sort((a,b)=>new Date(b.updatedAt||b.orderDate)-new Date(a.updatedAt||a.orderDate))
  .forEach((o,i)=>{
    const d=toDateObj(o.updatedAt||o.orderDate);
    tbody.innerHTML+=`<tr><td>${i+1}</td><td>${o.code||'-'}</td><td>${o.productName||'-'}</td>
    <td>${o.price||0}</td><td>${o.city||'-'}</td><td>${o.status||'-'}</td><td>${d?d.toLocaleString():'-'}</td><td>${o.fixedBy||'-'}</td></tr>`;
  });

  tipsBox.innerHTML=`<h3 style="color:var(--blue)">💡 أداء الموظف</h3>
  <p>عدد الطلبات: <b>${counts.total}</b></p>
  <p>تم التسليم: <b>${delivered}</b> | الراجع: <b>${returned}</b> | الرفض: <b>${rejected}</b></p>
  <p>نسبة الإنجاز: <b>${rate}%</b> | نسبة الراجع: <b>${returnRate}%</b></p>
  <p>💰 العمولة الكلية: <b>${commission.toLocaleString()} دينار</b></p>
  ${rate>85?'<p style="color:#198754">🏆 أداء ممتاز!</p>':''}
  ${returnRate>20?'<p style="color:#DC3545">⚠️ نسبة الراجع مرتفعة.</p>':''}`;
}
</script>
</body>
</html>
