<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>➕ إضافة طلب جديد - نظام المراد</title>
  <style>
    body {font-family: Tahoma, Arial; background: #f4f6fa; margin: 0;}
    header {background: #043B64; color: white; text-align: center; padding: 15px; font-size: 20px;}
    .container {
      max-width: 800px; margin: 30px auto; background: white;
      border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 25px;
    }
    .row {display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;}
    .field {flex: 1; min-width: 230px; display: flex; flex-direction: column;}
    label {font-weight: bold; margin-bottom: 4px; color: #043B64;}
    input, textarea, select {
      padding: 8px; border: 1px solid #ccc; border-radius: 6px;
      font-size: 14px; width: 100%;
    }
    textarea {resize: vertical; height: 70px;}
    button {
      background: #FF6B2D; color: white; border: none; border-radius: 8px;
      padding: 10px 20px; cursor: pointer; font-size: 15px; margin-top: 15px;
    }
    button:hover {opacity: 0.9;}
    #savedMsg {color: green; font-size: 13px; margin-top: 5px; display: none;}
    .dropdown-input {position: relative;}
    .dropdown-list {
      position: absolute; top: 100%; right: 0; width: 100%;
      background: #fff; border: 1px solid #ccc; border-radius: 6px;
      max-height: 180px; overflow-y: auto; z-index: 1000; display: none;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .dropdown-item {
      padding: 6px 8px; cursor: pointer; font-size: 13px;
    }
    .dropdown-item:hover {background: #f0f0f0;}
  </style>
</head>
<body>

  <header>➕ إضافة طلب جديد - نظام المراد</header>

  <div class="container">
    <div class="row">
      <div class="field"><label>الكود:</label><input id="code" type="text"></div>
      <div class="field"><label>رقم الموبايل:</label><input id="phone" type="text"></div>
      <div class="field"><label>الرقم الثاني:</label><input id="phone2" type="text"></div>
    </div>

    <div class="row">
      <div class="field"><label>المحافظة:</label><div id="city"></div></div>
      <div class="field"><label>المنطقة:</label><div id="area"></div></div>
    </div>

    <div class="field"><label>العنوان الكامل:</label><textarea id="address"></textarea></div>

    <div class="row">
      <div class="field"><label>السعر:</label><input id="price" type="number"></div>
      <div class="field"><label>عدد القطع:</label><input id="qty" type="number"></div>
    </div>

    <div class="field"><label>اسم المنتج:</label><div id="product"></div></div>
    <div class="field"><label>الملاحظات:</label><textarea id="note"></textarea></div>

    <div class="row">
      <div class="field">
        <label>الحالة:</label>
        <select id="status">
          <option value="">جديد</option>
          <option>مثبت</option>
          <option>قيد المعالجة</option>
          <option>قيد التجهيز</option>
          <option>قيد التوصيل</option>
          <option>تم التسليم</option>
          <option>راجع</option>
          <option>رفض</option>
        </select>
      </div>
      <div class="field"><label>المعلن:</label><input id="advertiser" type="text"></div>
    </div>

    <div id="savedMsg">✅ تم إضافة الطلب بنجاح</div>
    <button id="saveBtn">💾 حفظ الطلب</button>
    <button id="backBtn" style="background:#043B64;">🔙 رجوع</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { citiesData, allCities } from "./citiesData.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
      authDomain: "almurad-system.firebaseapp.com",
      projectId: "almurad-system",
      storageBucket: "almurad-system.appspot.com",
      messagingSenderId: "911755824405",
      appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 🔽 دالة عامة للقائمة المنسدلة
    function createDropdown(options, placeholder, onSelect) {
      const container = document.createElement("div");
      container.className = "dropdown-input";

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = placeholder;
      input.autocomplete = "off";

      const list = document.createElement("div");
      list.className = "dropdown-list";

      options.forEach(opt => {
        const item = document.createElement("div");
        item.className = "dropdown-item";
        item.textContent = opt;
        item.onclick = () => {
          input.value = opt;
          list.style.display = "none";
          onSelect(opt);
        };
        list.appendChild(item);
      });

      input.onfocus = () => list.style.display = "block";
      input.oninput = e => {
        const val = e.target.value.trim();
        Array.from(list.children).forEach(item => {
          item.style.display = item.textContent.includes(val) ? "block" : "none";
        });
      };

      document.addEventListener("click", e => {
        if (!container.contains(e.target)) list.style.display = "none";
      });

      container.appendChild(input);
      container.appendChild(list);
      return container;
    }

    let allProducts = [];
    async function loadProducts() {
      const snap = await getDocs(collection(db, "products"));
      allProducts = snap.docs.map(d => d.data().name);
    }

    // 🔹 تهيئة القوائم المنسدلة
    function setupDropdowns() {
      const cityDiv = document.getElementById("city");
      const areaDiv = document.getElementById("area");
      const productDiv = document.getElementById("product");

      const cityDropdown = createDropdown(allCities, "اختر المحافظة", val => {
        const newAreas = citiesData[val] || [];
        areaDiv.innerHTML = "";
        const areaDropdown = createDropdown(newAreas, "اختر المنطقة", () => {});
        areaDiv.appendChild(areaDropdown);
      });
      cityDiv.appendChild(cityDropdown);

      // المنطقة مبدئيًا فاضية لكن جاهزة
      const areaDropdown = createDropdown([], "اختر المنطقة", () => {});
      areaDiv.appendChild(areaDropdown);

      // المنتج
      const productDropdown = createDropdown(allProducts, "اختر المنتج", () => {});
      productDiv.appendChild(productDropdown);
    }

    // 💾 حفظ الطلب الجديد
    document.getElementById("saveBtn").addEventListener("click", async () => {
      const order = {
        code: document.getElementById("code").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        phone2: document.getElementById("phone2").value.trim(),
        address: document.getElementById("address").value.trim(),
        city: document.querySelector("#city input")?.value || "",
        area: document.querySelector("#area input")?.value || "",
        price: Number(document.getElementById("price").value),
        qty: Number(document.getElementById("qty").value),
        product: document.querySelector("#product input")?.value || "",
        note: document.getElementById("note").value.trim(),
        status: document.getElementById("status").value,
        advertiser: document.getElementById("advertiser").value.trim(),
        created_at: new Date()
      };

      if (!order.phone || !order.product) {
        alert("يرجى إدخال رقم الهاتف واسم المنتج على الأقل!");
        return;
      }

      await addDoc(collection(db, "orders"), order);
      const msg = document.getElementById("savedMsg");
      msg.style.display = "block";
      setTimeout(() => msg.style.display = "none", 2000);
    });

    document.getElementById("backBtn").onclick = () => window.location.href = "dashboard.html";

    await loadProducts();
    setupDropdowns();
  </script>

</body>
</html>
